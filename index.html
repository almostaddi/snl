<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snakes and Ladders</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        
        h1 {
            font-size: 3em;
            margin-bottom: 30px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        #gameContainer {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
        }
        
        #board {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            border: 4px solid #333;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            background: #fff;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            box-sizing: border-box;
            font-weight: bold;
            font-size: 0.9em;
            color: #333;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .square:hover {
            transform: scale(1.05);
            z-index: 5;
        }
        
        .snake {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            position: relative;
        }
        
        .snake::before {
            content: 'üêç';
            position: absolute;
            font-size: 3em;
            opacity: 0.3;
            pointer-events: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .snake::after {
            content: attr(data-destination);
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .ladder {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            position: relative;
        }
        
        .ladder::before {
            content: 'ü™ú';
            position: absolute;
            font-size: 3em;
            opacity: 0.3;
            pointer-events: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .ladder::after {
            content: attr(data-destination);
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.7em;
            padding: 2px 5px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .player {
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, #4dabf7 0%, #1864ab 100%);
            border-radius: 50%;
            position: absolute;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            animation: pulse 1s ease-in-out infinite;
            border: 3px solid white;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        #startButton {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 8px 20px rgba(81, 207, 102, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        #startButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(81, 207, 102, 0.5);
        }
        
        #startButton:active:not(:disabled) {
            transform: translateY(0);
        }
        
        #startButton:disabled {
            background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #rollDice {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        #rollDice:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(79, 172, 254, 0.5);
        }
        
        #rollDice:active:not(:disabled) {
            transform: translateY(0);
        }
        
        #rollDice:disabled {
            background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #diceResult {
            font-size: 28px;
            font-weight: bold;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ffd93d 0%, #ffbc00 100%);
            border-radius: 15px;
            color: #333;
            box-shadow: 0 4px 15px rgba(255, 188, 0, 0.3);
            min-width: 150px;
            text-align: center;
        }
        
        #instructions {
            margin-top: 20px;
            font-size: 18px;
            text-align: center;
            min-height: 80px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
        }
        
        #instructions.active {
            display: block;
        }
        
        #instructions img {
            margin-top: 15px;
            max-width: 150px;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        #instructions div {
            margin-bottom: 10px;
        }
        
        #continueButton {
            margin-top: 15px;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #fa5252 0%, #e03131 100%);
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 6px 20px rgba(250, 82, 82, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        #continueButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(250, 82, 82, 0.5);
        }
        
        #buttoncontainer {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .prize-settings {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            border: 2px solid #667eea;
        }
        
        .prize-settings h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        
        .slider-label .percentage {
            color: #667eea;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        #minorSlider {
            background: linear-gradient(to right, #51cf66, #37b24d);
        }
        
        #majorSlider {
            background: linear-gradient(to right, #ffd93d, #ffbc00);
        }
        
        #noPrizeSlider {
            background: linear-gradient(to right, #adb5bd, #868e96);
        }
        
        .metronome-container {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        
        .metronome-display {
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-align: center;
            margin: 15px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .metronome-beat {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            margin: 0 auto;
            transition: all 0.1s ease;
        }
        
        .metronome-beat.active {
            background: white;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }
        
        .metronome-btn {
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background: white;
            color: #4facfe;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            margin: 10px auto;
            display: block;
        }
        
        .metronome-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .metronome-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            padding-top: 60px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 80%;
            max-width: 600px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            color: #333;
        }
        
        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .modal-content p {
            line-height: 1.8;
            margin-bottom: 15px;
        }
        
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover,
        .close-btn:focus {
            color: #667eea;
            transform: rotate(90deg);
        }
        
        #patchNotesBtn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            z-index: 10;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }
        
        #patchNotesBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        
        #resetBtn {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            z-index: 10;
            background: linear-gradient(135deg, #fa5252 0%, #e03131 100%);
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(250, 82, 82, 0.4);
            transition: all 0.3s ease;
        }
        
        #resetBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(250, 82, 82, 0.5);
        }
        
        .prize-result {
            font-size: 2em;
            text-align: center;
            margin: 20px 0;
            padding: 30px;
            border-radius: 15px;
            animation: prizeReveal 0.5s ease-out;
        }
        
        @keyframes prizeReveal {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .prize-minor {
            background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
            color: white;
        }
        
        .prize-major {
            background: linear-gradient(135deg, #ffd93d 0%, #ffbc00 100%);
            color: #333;
        }
        
        .prize-none {
            background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%);
            color: white;
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2em;
            }
            
            #gameContainer {
                padding: 20px;
            }
            
            #buttoncontainer {
                flex-direction: column;
            }
            
            .square {
                font-size: 0.7em;
            }
            
            .player {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <h1>üé≤ Snakes and Ladders üé≤</h1>
    
    <div id="gameContainer">
        <div id="board"></div>
        
        <div id="controls">
            <button id="startButton">üéÆ Start Game</button>
            <button id="rollDice" style="display: none;">üé≤ Roll Dice</button>
            <div id="diceResult" style="display: none;">Dice: -</div>
        </div>
        
        <div id="instructions"></div>
        
        <div id="buttoncontainer">
            <div style="width: 100%; max-width: 400px;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">üì¶ Select Instruction Sets:</label>
                <div id="instructionSetCheckboxes" style="padding: 15px; background: white; border-radius: 10px; border: 2px solid #667eea;">
                    <label style="display: block; padding: 8px; cursor: pointer; color: #333;"><input type="checkbox" value="ball" style="margin-right: 10px; width: 18px; height: 18px; accent-color: #667eea;"> Ball Set üèÄ</label>
                    <label style="display: block; padding: 8px; cursor: pointer; color: #333;"><input type="checkbox" value="rope" style="margin-right: 10px; width: 18px; height: 18px; accent-color: #667eea;"> Rope Set ü™¢</label>
                    <label style="display: block; padding: 8px; cursor: pointer; color: #333;"><input type="checkbox" value="basketball_game" style="margin-right: 10px; width: 18px; height: 18px; accent-color: #667eea;"> Basketball Game Set üèÄ</label>
                </div>
                
                <div id="toyCheckboxContainer" style="width: 100%; margin-top: 15px;">
                    <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">üéØ Select Your Toys & Difficulty:</label>
                    <div id="toyCheckboxes" style="padding: 15px; background: white; border-radius: 10px; border: 2px solid #20c997; min-height: 60px;">
                        <p style="color: #666; text-align: center; margin: 0;">Select instruction sets first</p>
                    </div>
                </div>
                
                <div class="prize-settings">
                    <h3>üéÅ Prize Probabilities</h3>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>üéâ Minor Prize:</span>
                            <span class="percentage" id="minorPercent">25%</span>
                        </div>
                        <input type="range" id="minorSlider" min="0" max="100" value="25">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>üèÜ Major Prize:</span>
                            <span class="percentage" id="majorPercent">10%</span>
                        </div>
                        <input type="range" id="majorSlider" min="0" max="100" value="10">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>‚ùå No Prize:</span>
                            <span class="percentage" id="noPrizePercent">65%</span>
                        </div>
                        <input type="range" id="noPrizeSlider" min="0" max="100" value="65">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <button id="resetBtn">üîÑ Reset</button>
    <button id="patchNotesBtn">üìã Patch Notes</button>
    
    <div id="patchNotesModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>üìã Patch Notes</h2>
            <p><strong>12/15/2024 Ver 0.1:</strong><br>Initial release.</p>
            <p><strong>12/28/2024 Ver 0.2:</strong><br>Added selectable instruction sets that randomly add images and instructions for each square that the player lands on.<br><br>Added dice sound effect.</p>
            <p><strong>01/15/2026 Ver 0.3:</strong><br>Added metronome feature to basketball bounce task with countdown and beat indicator.</p>
            <p><strong>01/16/2026 Ver 0.4:</strong><br>Added prize probability system with adjustable sliders for minor prize, major prize, and no prize outcomes.</p>
        </div>
    </div>
    
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Reset Game?</h2>
            <p style="font-size: 18px; margin: 20px 0;">Are you sure? You will lose all progress!</p>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button id="confirmReset" style="padding: 12px 30px; font-size: 16px; background: linear-gradient(135deg, #fa5252 0%, #e03131 100%); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">Yes, Reset</button>
                <button id="cancelReset" style="padding: 12px 30px; font-size: 16px; background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const board = document.getElementById('board');
        const diceResult = document.getElementById('diceResult');
        const instructions = document.getElementById('instructions');
        const startButton = document.getElementById('startButton');
        const rollDiceButton = document.getElementById('rollDice');
        const continueButton = document.createElement('button');
        continueButton.id = "continueButton";
        continueButton.textContent = "‚úì Complete";

        const boardSize = 10;
        const totalSquares = boardSize * boardSize;
        const player = document.createElement('div');
        player.classList.add('player');

        const snakes = {
            16: 6, 47: 26, 49: 11, 56: 53, 62: 19,
            64: 60, 87: 24, 93: 73, 95: 75, 98: 78
        };

        const ladders = {
            1: 38, 4: 14, 9: 31, 21: 42, 28: 84,
            36: 44, 51: 67, 71: 91, 80: 99
        };

        let audioContext = null;
        let currentMetronomeTask = null;
        let toyDifficulties = {};
        let gameStarted = false;
        
        function saveGameState() {
            const gameState = {
                gameStarted: gameStarted,
                playerPosition: playerPosition,
                selectedSets: selectedSets,
                toySelections: toySelections,
                toyDifficulties: toyDifficulties,
                prizeSettings: prizeSettings,
                diceResultText: diceResult.textContent,
                currentInstruction: instructions.innerHTML,
                instructionsActive: instructions.classList.contains('active'),
                lastTaskInfo: window.lastTaskInfo || null
            };
            localStorage.setItem('snakesLaddersGameState', JSON.stringify(gameState));
        }
        
        function loadGameState() {
            const saved = localStorage.getItem('snakesLaddersGameState');
            if (!saved) return false;
            
            try {
                const gameState = JSON.parse(saved);
                gameStarted = gameState.gameStarted;
                playerPosition = gameState.playerPosition;
                selectedSets = gameState.selectedSets || [];
                toySelections = gameState.toySelections || {};
                toyDifficulties = gameState.toyDifficulties || {};
                
                if (gameState.prizeSettings) {
                    prizeSettings = gameState.prizeSettings;
                    updateSliderDisplays();
                }
                
                if (gameStarted) {
                    startButton.style.display = 'none';
                    rollDiceButton.style.display = 'block';
                    diceResult.style.display = 'block';
                    diceResult.textContent = gameState.diceResultText || 'Dice: -';
                    
                    document.getElementById('instructionSetCheckboxes').parentElement.style.display = 'none';
                    document.getElementById('toyCheckboxContainer').style.display = 'none';
                    document.querySelector('.prize-settings').style.display = 'none';
                    
                    createBoard();
                    
                    if (playerPosition > 0) {
                        const targetSquare = document.getElementById(`square-${playerPosition}`);
                        if (targetSquare) targetSquare.appendChild(player);
                    }
                    
                    // Restore the task
                    if (gameState.lastTaskInfo) {
                        window.lastTaskInfo = gameState.lastTaskInfo;
                        instructions.classList.add('active');
                        
                        if (gameState.lastTaskInfo.taskType === 'metronome') {
                            currentMetronomeTask = createMetronomeTask(gameState.lastTaskInfo.beatCount);
                            instructions.innerHTML = '';
                            instructions.appendChild(currentMetronomeTask.element);
                        } else if (gameState.lastTaskInfo.taskType === 'redlight') {
                            currentMetronomeTask = createRedLightGreenLightTask(gameState.lastTaskInfo.duration);
                            instructions.innerHTML = '';
                            instructions.appendChild(currentMetronomeTask.element);
                        } else {
                            // Regular HTML task
                            instructions.innerHTML = gameState.currentInstruction;
                        }
                    } else if (gameState.currentInstruction) {
                        instructions.innerHTML = gameState.currentInstruction;
                        if (gameState.instructionsActive) {
                            instructions.classList.add('active');
                        }
                    }
                } else {
                    updateToyCheckboxes();
                }
                
                return true;
            } catch (e) {
                console.error('Error loading game state:', e);
                return false;
            }
        }
        
        function clearGameState() {
            localStorage.removeItem('snakesLaddersGameState');
        }
        
        let prizeSettings = {
            minor: 25,
            major: 10,
            noPrize: 65
        };
        
        const minorSlider = document.getElementById('minorSlider');
        const majorSlider = document.getElementById('majorSlider');
        const noPrizeSlider = document.getElementById('noPrizeSlider');
        const minorPercent = document.getElementById('minorPercent');
        const majorPercent = document.getElementById('majorPercent');
        const noPrizePercent = document.getElementById('noPrizePercent');
        
        function updateSliderDisplays() {
            minorPercent.textContent = prizeSettings.minor.toFixed(1) + '%';
            majorPercent.textContent = prizeSettings.major.toFixed(1) + '%';
            noPrizePercent.textContent = prizeSettings.noPrize.toFixed(1) + '%';
            
            minorSlider.value = prizeSettings.minor;
            majorSlider.value = prizeSettings.major;
            noPrizeSlider.value = prizeSettings.noPrize;
            
            saveGameState();
        }
        
        minorSlider.addEventListener('input', function() {
            const newMinor = parseInt(this.value);
            const maxAllowed = 100 - prizeSettings.major;
            
            if (newMinor > maxAllowed) {
                prizeSettings.minor = maxAllowed;
            } else {
                prizeSettings.minor = newMinor;
            }
            
            prizeSettings.noPrize = 100 - prizeSettings.minor - prizeSettings.major;
            updateSliderDisplays();
        });
        
        majorSlider.addEventListener('input', function() {
            const newMajor = parseInt(this.value);
            const maxAllowed = 100 - prizeSettings.minor;
            
            if (newMajor > maxAllowed) {
                prizeSettings.major = maxAllowed;
            } else {
                prizeSettings.major = newMajor;
            }
            
            prizeSettings.noPrize = 100 - prizeSettings.minor - prizeSettings.major;
            updateSliderDisplays();
        });
        
        noPrizeSlider.addEventListener('input', function() {
            const newNoPrize = parseInt(this.value);
            const availableForPrizes = 100 - newNoPrize;
            const currentPrizeTotal = prizeSettings.minor + prizeSettings.major;
            
            if (availableForPrizes < currentPrizeTotal) {
                // Need to reduce prizes
                const reductionNeeded = currentPrizeTotal - availableForPrizes;
                
                // Reduce from each proportionally to their current values
                if (currentPrizeTotal > 0) {
                    const minorProportion = prizeSettings.minor / currentPrizeTotal;
                    const majorProportion = prizeSettings.major / currentPrizeTotal;
                    
                    prizeSettings.minor -= reductionNeeded * minorProportion;
                    prizeSettings.major -= reductionNeeded * majorProportion;
                    
                    // Clean up floating point errors
                    prizeSettings.minor = Math.max(0, Math.round(prizeSettings.minor * 10) / 10);
                    prizeSettings.major = Math.max(0, Math.round(prizeSettings.major * 10) / 10);
                }
            } else if (availableForPrizes > currentPrizeTotal) {
                // Can increase prizes - add equally to both
                const increaseAmount = availableForPrizes - currentPrizeTotal;
                prizeSettings.minor += increaseAmount / 2;
                prizeSettings.major += increaseAmount / 2;
            }
            
            // Force exact total
            const actualTotal = prizeSettings.minor + prizeSettings.major;
            if (Math.abs(actualTotal - availableForPrizes) > 0.01) {
                const correction = availableForPrizes - actualTotal;
                prizeSettings.minor += correction / 2;
                prizeSettings.major += correction / 2;
            }
            
            prizeSettings.noPrize = newNoPrize;
            updateSliderDisplays();
        });
        
        function determinePrize() {
            const roll = Math.random() * 100;
            
            if (roll < prizeSettings.major) {
                return 'major';
            } else if (roll < prizeSettings.major + prizeSettings.minor) {
                return 'minor';
            } else {
                return 'none';
            }
        }
        
        function displayPrizeResult(prize) {
            let prizeHTML = '';
            
            if (prize === 'major') {
                prizeHTML = '<div class="prize-result prize-major">üèÜ MAJOR PRIZE! üèÜ<br>Congratulations!</div>';
            } else if (prize === 'minor') {
                prizeHTML = '<div class="prize-result prize-minor">üéâ Minor Prize! üéâ<br>Nice job!</div>';
            } else {
                prizeHTML = '<div class="prize-result prize-none">‚ùå No Prize<br>Better luck next time!</div>';
            }
            
            return prizeHTML;
        }
        
        function createMetronomeTask(beatCount) {
            let metronomeInterval = null;
            let countdownInterval = null;
            let isComplete = false;
            
            const container = document.createElement('div');
            container.className = 'metronome-container';
            
            container.innerHTML = `
                <div><strong>üèÄ Bounce to the Beat!</strong></div>
                <p style="color: white; margin: 10px 0;">Bounce the basketball in rhythm with the metronome.</p>
                <div class="metronome-beat" id="metronomeBeat"></div>
                <div class="metronome-display" id="metronomeDisplay">Ready?</div>
                <button class="metronome-btn" id="startMetronome">‚ñ∂Ô∏è Start</button>
            `;
            
            const startBtn = container.querySelector('#startMetronome');
            const display = container.querySelector('#metronomeDisplay');
            const beat = container.querySelector('#metronomeBeat');
            
            startBtn.addEventListener('click', function() {
                startBtn.disabled = true;
                
                let count = 3;
                display.textContent = count;
                
                countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        display.textContent = count;
                    } else {
                        clearInterval(countdownInterval);
                        display.textContent = "Bounce!";
                        startMetronome();
                    }
                }, 1000);
            });
            
            function playBeep() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.type = 'sine';
                osc.frequency.value = 440;
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.05);
            }
            
            function startMetronome() {
                let beatsLeft = beatCount;
                const bpm = 100;
                const interval = 60000 / bpm;
                
                function doBeat() {
                    beatsLeft--;
                    
                    beat.classList.add('active');
                    playBeep();
                    display.textContent = `${beatsLeft} bounces left`;
                    
                    setTimeout(() => {
                        beat.classList.remove('active');
                    }, 100);
                    
                    if (beatsLeft <= 0) {
                        clearInterval(metronomeInterval);
                        display.textContent = "Complete! ‚úì";
                        isComplete = true;
                        continueButton.disabled = false;
                        continueButton.style.opacity = '1';
                    }
                }
                
                doBeat();
                metronomeInterval = setInterval(doBeat, interval);
                
                continueButton.disabled = true;
                continueButton.style.opacity = '0.5';
            }
            
            return {
                element: container,
                isComplete: () => isComplete,
                cleanup: () => {
                    if (metronomeInterval) clearInterval(metronomeInterval);
                    if (countdownInterval) clearInterval(countdownInterval);
                },
                hasStarted: () => startBtn.disabled
            };
        }
        
        function createRedLightGreenLightTask(totalDuration) {
            let gameInterval = null;
            let countdownInterval = null;
            let isComplete = false;
            let timeRemaining = totalDuration;
            
            const imagePatterns = [
                { image: 'chair.jpg', name: 'Chair', type: 'red' },
                { image: 'broom.jpg', name: 'Broom', type: 'green' },
                { image: 'hat.jpg', name: 'Hat', type: 'red' },
                { image: 'ball.jpg', name: 'Ball', type: 'green' },
                { image: 'books.jpg', name: 'Books', type: 'red' },
                { image: 'car.jpg', name: 'Car', type: 'green' },
                { image: 'tree.jpg', name: 'Tree', type: 'red' },
                { image: 'guitar.jpg', name: 'Guitar', type: 'green' },
                { image: 'apple.jpg', name: 'Apple', type: 'red' },
                { image: 'bike.jpg', name: 'Bike', type: 'green' }
            ];
            
            const lightPatterns = [
                { duration: 2000 },
                { duration: 1500 },
                { duration: 1500 },
                { duration: 2500 },
                { duration: 1000 },
                { duration: 3000 },
                { duration: 2000 },
                { duration: 1500 }
            ];
            
            const container = document.createElement('div');
            container.className = 'metronome-container';
            container.style.background = 'linear-gradient(135deg, #845ef7 0%, #5f3dc4 100%)';
            
            container.innerHTML = `
                <div><strong>üö¶ Red Light, Green Light!</strong></div>
                <p style="color: white; margin: 10px 0;">üü¢ GREEN = Jump! | üî¥ RED = Stop!</p>
                <div style="background: rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 20px; margin: 15px 0;">
                    <div style="width: 150px; height: 150px; margin: 0 auto 10px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden;" id="imageContainer">
                        <div style="font-size: 3em; color: #845ef7;">üö¶</div>
                    </div>
                    <div style="color: white; font-size: 1.2em; font-weight: bold;" id="imageName">Get Ready!</div>
                </div>
                <div style="width: 120px; height: 120px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 4em; transition: all 0.3s ease;" id="lightIndicator">
                    ‚è∏Ô∏è
                </div>
                <div class="metronome-display" id="lightDisplay">Press Start!</div>
                <div style="color: white; font-size: 18px; margin: 10px 0;" id="timeDisplay"></div>
                <button class="metronome-btn" id="startRedLight">‚ñ∂Ô∏è Start</button>
            `;
            
            const startBtn = container.querySelector('#startRedLight');
            const display = container.querySelector('#lightDisplay');
            const lightIndicator = container.querySelector('#lightIndicator');
            const timeDisplay = container.querySelector('#timeDisplay');
            const imageContainer = container.querySelector('#imageContainer');
            const imageName = container.querySelector('#imageName');
            
            startBtn.addEventListener('click', function() {
                startBtn.disabled = true;
                
                let count = 3;
                imageContainer.innerHTML = `<div style="font-size: 4em; color: #845ef7;">${count}</div>`;
                imageName.textContent = 'Starting...';
                lightIndicator.textContent = '‚è≥';
                display.textContent = 'Get ready...';
                
                countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        imageContainer.innerHTML = `<div style="font-size: 4em; color: #845ef7;">${count}</div>`;
                    } else {
                        clearInterval(countdownInterval);
                        startGame();
                    }
                }, 1000);
            });
            
            function startGame() {
                let currentImageIndex = 0;
                let currentPatternIndex = 0;
                
                function showNextLight() {
                    if (timeRemaining <= 0) {
                        clearInterval(gameInterval);
                        display.textContent = "Game Complete! ‚úì";
                        lightIndicator.textContent = "‚úì";
                        lightIndicator.style.background = "linear-gradient(135deg, #51cf66 0%, #37b24d 100%)";
                        imageContainer.innerHTML = '<div style="font-size: 4em; color: #51cf66;">üéâ</div>';
                        imageName.textContent = "Great Job!";
                        timeDisplay.textContent = "";
                        isComplete = true;
                        continueButton.disabled = false;
                        continueButton.style.opacity = '1';
                        return;
                    }
                    
                    const currentImage = imagePatterns[currentImageIndex];
                    const pattern = lightPatterns[currentPatternIndex];
                    
                    imageContainer.innerHTML = `<img src="${currentImage.image}" alt="${currentImage.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size: 3em; color: #845ef7;\\'>${currentImage.name[0]}</div>';">`;
                    imageName.textContent = currentImage.name;
                    
                    lightIndicator.textContent = currentImage.type === 'green' ? 'üü¢' : 'üî¥';
                    display.textContent = currentImage.type === 'green' ? 'GREEN LIGHT - JUMP!' : 'RED LIGHT - STOP!';
                    
                    if (currentImage.type === 'green') {
                        lightIndicator.style.background = 'linear-gradient(135deg, #51cf66 0%, #37b24d 100%)';
                        lightIndicator.style.transform = 'scale(1.2)';
                    } else {
                        lightIndicator.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';
                        lightIndicator.style.transform = 'scale(1)';
                    }
                    
                    const displayDuration = Math.min(pattern.duration, timeRemaining);
                    timeRemaining -= displayDuration;
                    timeDisplay.textContent = `${Math.ceil(timeRemaining / 1000)}s remaining`;
                    
                    setTimeout(() => {
                        currentImageIndex++;
                        if (currentImageIndex >= imagePatterns.length) {
                            currentImageIndex = 0;
                        }
                        
                        currentPatternIndex++;
                        if (currentPatternIndex >= lightPatterns.length) {
                            currentPatternIndex = 0;
                        }
                        
                        showNextLight();
                    }, displayDuration);
                }
                
                continueButton.disabled = true;
                continueButton.style.opacity = '0.5';
                
                showNextLight();
            }
            
            return {
                element: container,
                isComplete: () => isComplete,
                cleanup: () => {
                    if (gameInterval) clearInterval(gameInterval);
                    if (countdownInterval) clearInterval(countdownInterval);
                },
                hasStarted: () => startBtn.disabled
            };
        }

        const instructionSets = {
            ball: {
                name: "Ball Set",
                toys: [
                    { id: "basketball", name: "Basketball üèÄ" },
                    { id: "soccerball", name: "Soccer Ball ‚öΩ" }
                ],
                tasks: {
                    basketball: [
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 5, medium: 10, hard: 15};
                                return `
                                    <div><strong>Bounce the basketball ${counts[diff]} times!</strong></div>
                                    <img src="https://picsum.photos/seed/basketball1/800/600" alt="Basketball" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        },
                        {
                            type: 'metronome',
                            getDifficulty: (diff) => {
                                const counts = {easy: 8, medium: 10, hard: 15};
                                return counts[diff];
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 3, medium: 5, hard: 8};
                                return `
                                    <div><strong>Spin the basketball on your finger!</strong></div>
                                    <img src="https://picsum.photos/seed/basketball2/800/600" alt="Basketball Spinning" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                    <p style="margin-top: 10px; font-size: 14px; color: #666;">Keep trying until you can hold it for ${counts[diff]} seconds!</p>
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 3, medium: 5, hard: 10};
                                return `
                                    <div><strong>Pass the basketball around your waist ${counts[diff]} times!</strong></div>
                                    <img src="https://picsum.photos/seed/basketball3/800/600" alt="Basketball" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        }
                    ],
                    soccerball: [
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 3, medium: 5, hard: 10};
                                return `
                                    <div><strong>Kick the soccer ball ${counts[diff]} times!</strong></div>
                                    <img src="https://picsum.photos/seed/soccer1/800/600" alt="Soccer Ball" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 2, medium: 3, hard: 5};
                                return `
                                    <div><strong>Juggling Challenge!</strong></div>
                                    <p>Try to juggle the soccer ball ${counts[diff]} times without it touching the ground.</p>
                                    <img src="https://picsum.photos/seed/soccer2/800/600" alt="Soccer Juggling" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                    <p style="margin-top: 10px; font-size: 14px; color: #666;">Use your feet, knees, or head!</p>
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 3, medium: 5, hard: 8};
                                return `
                                    <div><strong>Roll the soccer ball in a circle ${counts[diff]} times!</strong></div>
                                    <img src="https://picsum.photos/seed/soccer3/800/600" alt="Soccer Ball" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        }
                    ]
                }
            },
            rope: {
                name: "Rope Set",
                toys: [
                    { id: "jumprope", name: "Jump Rope ü™¢" },
                    { id: "climbingrope", name: "Climbing Rope üßó" }
                ],
                tasks: {
                    jumprope: [
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 10, medium: 15, hard: 25};
                                return `
                                    <div><strong>Jump rope ${counts[diff]} times!</strong></div>
                                    <img src="https://picsum.photos/seed/jumprope1/800/600" alt="Jump Rope" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        },
                        {
                            type: 'redlight',
                            getDifficulty: (diff) => {
                                const durations = {easy: 15000, medium: 20000, hard: 30000};
                                return durations[diff];
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 3, medium: 5, hard: 8};
                                return `
                                    <div><strong>Criss-Cross Challenge!</strong></div>
                                    <p>Do ${counts[diff]} criss-cross jumps with the jump rope.</p>
                                    <img src="https://picsum.photos/seed/jumprope2/800/600" alt="Jump Rope" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                    <p style="margin-top: 10px; font-size: 14px; color: #666;">Cross your arms while the rope is in the air!</p>
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 5, medium: 10, hard: 15};
                                return `
                                    <div><strong>Jump rope backwards ${counts[diff]} times!</strong></div>
                                    <img src="https://picsum.photos/seed/jumprope3/800/600" alt="Jump Rope" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        }
                    ],
                    climbingrope: [
                        {
                            getDifficulty: (diff) => {
                                const distances = {easy: '2 feet', medium: '3 feet', hard: '5 feet'};
                                return `
                                    <div><strong>Climb the rope ${distances[diff]} up!</strong></div>
                                    <img src="https://picsum.photos/seed/climbrope1/800/600" alt="Climbing Rope" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 5, medium: 10, hard: 15};
                                return `
                                    <div><strong>Hanging Challenge!</strong></div>
                                    <p>Hang from the climbing rope for ${counts[diff]} seconds.</p>
                                    <img src="https://picsum.photos/seed/climbrope2/800/600" alt="Rope Climb" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                    <p style="margin-top: 10px; font-size: 14px; color: #666;">Keep your feet off the ground!</p>
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 2, medium: 3, hard: 5};
                                return `
                                    <div><strong>Do ${counts[diff]} rope pull-ups!</strong></div>
                                    <img src="https://picsum.photos/seed/climbrope3/800/600" alt="Climbing" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        }
                    ]
                }
            },
            basketball_game: {
                name: "Basketball Game Set",
                toys: [
                    { id: "basketball_hoop", name: "Basketball with Hoop üèÄ" }
                ],
                tasks: {
                    basketball_hoop: [
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 2, medium: 3, hard: 5};
                                return `
                                    <div><strong>Free Throw Challenge!</strong></div>
                                    <p>Make ${counts[diff]} baskets from the free throw line.</p>
                                    <img src="https://picsum.photos/seed/hoop1/800/600" alt="Basketball Hoop" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                    <p style="margin-top: 10px; font-size: 14px; color: #666;">Take your time and aim carefully!</p>
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 1, medium: 2, hard: 3};
                                return `
                                    <div><strong>Make ${counts[diff]} layup shot${counts[diff] > 1 ? 's' : ''}!</strong></div>
                                    <img src="https://picsum.photos/seed/hoop2/800/600" alt="Basketball Layup" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                `;
                            }
                        },
                        {
                            getDifficulty: (diff) => {
                                const counts = {easy: 1, medium: 2, hard: 3};
                                return `
                                    <div><strong>3-Pointer Challenge!</strong></div>
                                    <p>Try to make ${counts[diff]} shot${counts[diff] > 1 ? 's' : ''} from the 3-point line!</p>
                                    <img src="https://picsum.photos/seed/hoop3/800/600" alt="Basketball 3-pointer" style="max-width: 100%; height: auto; border-radius: 10px; margin-top: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" />
                                    <p style="margin-top: 10px; font-size: 14px; color: #666;">Don't worry if you miss - just have fun!</p>
                                `;
                            }
                        }
                    ]
                }
            }
        };
        
        let selectedSets = [];
        let toySelections = {};

        let playerPosition = 0;
        let isMoving = false;

        function createBoard() {
            let reverse = false;
            let currentNumber = 1;

            for (let row = 0; row < boardSize; row++) {
                for (let col = 0; col < boardSize; col++) {
                    const actualCol = reverse ? boardSize - col - 1 : col;
                    const square = document.createElement('div');
                    square.classList.add('square');
                    square.textContent = currentNumber;
                    square.id = `square-${currentNumber}`;
                    square.style.gridRow = boardSize - row;
                    square.style.gridColumn = actualCol + 1;

                    if (snakes[currentNumber]) {
                        square.classList.add('snake');
                        square.setAttribute('data-destination', '‚Üì' + snakes[currentNumber]);
                    } else if (ladders[currentNumber]) {
                        square.classList.add('ladder');
                        square.setAttribute('data-destination', '‚Üë' + ladders[currentNumber]);
                    }

                    board.appendChild(square);
                    currentNumber++;
                }
                reverse = !reverse;
            }
        }

        function animatePlayer(start, end, callback, instant = false) {
            if (instant) {
                const targetSquare = document.getElementById(`square-${end}`);
                if (targetSquare) targetSquare.appendChild(player);
                if (callback) callback();
                return;
            }

            let current = start;
            const step = current < end ? 1 : -1;
            const interval = setInterval(() => {
                current += step;
                const currentSquare = document.getElementById(`square-${current}`);
                if (currentSquare) currentSquare.appendChild(player);

                if (current === end) {
                    clearInterval(interval);
                    if (callback) callback();
                }
            }, 200);
        }

        function getSelectedToys() {
            const allToys = [];
            document.querySelectorAll('#toyCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                const toyKey = `${cb.dataset.setId}_${cb.value}`;
                const difficultySelect = document.getElementById(`difficulty_${toyKey}`);
                allToys.push({
                    toyId: cb.value,
                    setId: cb.dataset.setId,
                    difficulty: difficultySelect ? difficultySelect.value : 'medium'
                });
            });
            return allToys;
        }

        function displayRandomInstruction() {
            const toys = getSelectedToys();
            
            if (currentMetronomeTask) {
                currentMetronomeTask.cleanup();
                currentMetronomeTask = null;
            }
            
            if (toys.length === 0) {
                instructions.classList.add('active');
                instructions.innerHTML = "<div>üéØ Select instruction sets and toys to get started!</div>";
                window.lastTaskInfo = null;
                saveGameState();
                return;
            }

            const randomToyObj = toys[Math.floor(Math.random() * toys.length)];
            const tasks = instructionSets[randomToyObj.setId].tasks[randomToyObj.toyId];
            
            if (!tasks || tasks.length === 0) {
                instructions.classList.add('active');
                instructions.innerHTML = "<div>No tasks available for this toy!</div>";
                window.lastTaskInfo = null;
                saveGameState();
                return;
            }

            const randomTask = tasks[Math.floor(Math.random() * tasks.length)];

            // Save task info for restoration
            window.lastTaskInfo = {
                toyId: randomToyObj.toyId,
                setId: randomToyObj.setId,
                difficulty: randomToyObj.difficulty,
                taskType: randomTask.type || 'normal'
            };

            instructions.classList.add('active');
            if (randomTask.type === 'metronome') {
                const beatCount = randomTask.getDifficulty(randomToyObj.difficulty);
                window.lastTaskInfo.beatCount = beatCount;
                currentMetronomeTask = createMetronomeTask(beatCount);
                instructions.innerHTML = '';
                instructions.appendChild(currentMetronomeTask.element);
            } else if (randomTask.type === 'redlight') {
                const duration = randomTask.getDifficulty(randomToyObj.difficulty);
                window.lastTaskInfo.duration = duration;
                currentMetronomeTask = createRedLightGreenLightTask(duration);
                instructions.innerHTML = '';
                instructions.appendChild(currentMetronomeTask.element);
            } else {
                const content = randomTask.getDifficulty(randomToyObj.difficulty);
                instructions.innerHTML = content;
            }
            
            saveGameState();
        }
        
        function updateToyCheckboxes() {
            selectedSets = Array.from(document.querySelectorAll('#instructionSetCheckboxes input:checked')).map(cb => cb.value);
            const container = document.getElementById('toyCheckboxes');
            container.innerHTML = '';
            
            if (selectedSets.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; margin: 0;">Select instruction sets first</p>';
                return;
            }
            
            selectedSets.forEach(setId => {
                if (instructionSets[setId]) {
                    const setHeader = document.createElement('div');
                    setHeader.style.fontWeight = 'bold';
                    setHeader.style.color = '#667eea';
                    setHeader.style.marginTop = '10px';
                    setHeader.style.marginBottom = '5px';
                    setHeader.textContent = instructionSets[setId].name;
                    if (container.children.length > 0) container.appendChild(setHeader);
                    
                    instructionSets[setId].toys.forEach(toy => {
                        const toyKey = `${setId}_${toy.id}`;
                        
                        const itemContainer = document.createElement('div');
                        itemContainer.style.display = 'flex';
                        itemContainer.style.alignItems = 'center';
                        itemContainer.style.justifyContent = 'space-between';
                        itemContainer.style.padding = '8px';
                        itemContainer.style.paddingLeft = '20px';
                        itemContainer.style.borderRadius = '8px';
                        itemContainer.style.transition = 'background 0.2s';
                        itemContainer.onmouseover = () => itemContainer.style.background = '#e9ecef';
                        itemContainer.onmouseout = () => itemContainer.style.background = 'transparent';
                        
                        const label = document.createElement('label');
                        label.style.cursor = 'pointer';
                        label.style.color = '#333';
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.flex = '1';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = toy.id;
                        checkbox.dataset.setId = setId;
                        checkbox.style.width = '18px';
                        checkbox.style.height = '18px';
                        checkbox.style.marginRight = '10px';
                        checkbox.style.accentColor = '#20c997';
                        checkbox.style.cursor = 'pointer';
                        
                        if (toySelections[toyKey]) {
                            checkbox.checked = true;
                        }
                        
                        checkbox.addEventListener('change', () => {
                            toySelections[toyKey] = checkbox.checked;
                            saveGameState();
                        });
                        
                        const text = document.createTextNode(toy.name);
                        
                        label.appendChild(checkbox);
                        label.appendChild(text);
                        
                        const difficultySelect = document.createElement('select');
                        difficultySelect.id = `difficulty_${toyKey}`;
                        difficultySelect.style.padding = '4px 8px';
                        difficultySelect.style.borderRadius = '8px';
                        difficultySelect.style.border = '2px solid #667eea';
                        difficultySelect.style.backgroundColor = 'white';
                        difficultySelect.style.color = '#333';
                        difficultySelect.style.cursor = 'pointer';
                        difficultySelect.style.fontSize = '14px';
                        
                        const easyOption = document.createElement('option');
                        easyOption.value = 'easy';
                        easyOption.textContent = 'Easy üòä';
                        
                        const mediumOption = document.createElement('option');
                        mediumOption.value = 'medium';
                        mediumOption.textContent = 'Medium üòê';
                        mediumOption.selected = true;
                        
                        const hardOption = document.createElement('option');
                        hardOption.value = 'hard';
                        hardOption.textContent = 'Hard üò§';
                        
                        difficultySelect.appendChild(easyOption);
                        difficultySelect.appendChild(mediumOption);
                        difficultySelect.appendChild(hardOption);
                        
                        if (toyDifficulties[toyKey]) {
                            difficultySelect.value = toyDifficulties[toyKey];
                        }
                        
                        difficultySelect.addEventListener('change', () => {
                            toyDifficulties[toyKey] = difficultySelect.value;
                            saveGameState();
                        });
                        
                        itemContainer.appendChild(label);
                        itemContainer.appendChild(difficultySelect);
                        container.appendChild(itemContainer);
                    });
                }
            });
            
            saveGameState();
        }
        
        document.querySelectorAll('#instructionSetCheckboxes input').forEach(cb => {
            cb.addEventListener('change', () => {
                updateToyCheckboxes();
                saveGameState();
            });
        });

        function playDiceRollSound() {
            console.log("üé≤ Rolling dice...");
        }
        
        function startGame() {
            const toys = getSelectedToys();
            
            if (toys.length === 0) {
                alert('‚ö†Ô∏è Please select at least one toy from the instruction sets before starting!');
                return;
            }
            
            gameStarted = true;
            saveGameState();
            
            startButton.style.display = 'none';
            document.getElementById('instructionSetCheckboxes').parentElement.style.display = 'none';
            document.getElementById('toyCheckboxContainer').style.display = 'none';
            document.querySelector('.prize-settings').style.display = 'none';
            
            instructions.classList.add('active');
            instructions.innerHTML = `
                <div style="font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 20px;">
                    üçÄ Good Luck! üçÄ
                </div>
                <div style="font-size: 1.2em; color: #666; margin-bottom: 20px;">
                    Roll the dice to begin your adventure!
                </div>
            `;
            
            rollDiceButton.style.display = 'block';
            diceResult.style.display = 'block';
        }

        function rollDice() {
            playDiceRollSound();
            rollDiceButton.disabled = true;

            const diceRoll = Math.floor(Math.random() * 6) + 1;
            diceResult.textContent = `Dice: ${diceRoll} üé≤`;

            let nextPosition = playerPosition + diceRoll;
            if (nextPosition > totalSquares) nextPosition = totalSquares;

            let finalPosition = nextPosition;
            let showContinueButton = false;

            const isSnake = snakes[nextPosition];
            const isLadder = ladders[nextPosition];

            if (isSnake || isLadder) {
                finalPosition = isSnake ? snakes[nextPosition] : ladders[nextPosition];
                showContinueButton = true;
            }

            animatePlayer(playerPosition, nextPosition, () => {
                playerPosition = nextPosition;
                saveGameState();

                displayRandomInstruction();

                if (playerPosition === totalSquares) {
                    rollDiceButton.disabled = true;
                    const prize = determinePrize();
                    instructions.innerHTML = `<div><strong>üéâ Congratulations, you've won! üéâ</strong></div>` + displayPrizeResult(prize);
                    return;
                }

                instructions.appendChild(continueButton);
                continueButton.style.display = "block";

                if (showContinueButton) {
                    continueButton.onclick = () => {
                        if (currentMetronomeTask && !currentMetronomeTask.isComplete()) {
                            return;
                        }
                        
                        continueButton.style.display = "none";

                        animatePlayer(nextPosition, finalPosition, () => {
                            playerPosition = finalPosition;
                            saveGameState();
                            
                            if (playerPosition === totalSquares) {
                                rollDiceButton.disabled = true;
                                const prize = determinePrize();
                                instructions.innerHTML = `<div><strong>üéâ Congratulations, you've won! üéâ</strong></div>` + displayPrizeResult(prize);
                            } else {
                                rollDiceButton.disabled = false;
                                instructions.innerHTML = `<div><strong>üìç You landed on ${finalPosition}.</strong></div>`;
                                displayRandomInstruction();
                            }
                        }, true);
                    };
                } else {
                    continueButton.onclick = () => {
                        if (currentMetronomeTask && !currentMetronomeTask.isComplete()) {
                            return;
                        }
                        
                        continueButton.style.display = "none";
                        rollDiceButton.disabled = false;
                    };
                }
            });
        }

        const modal = document.getElementById('patchNotesModal');
        const btn = document.getElementById('patchNotesBtn');
        const span = document.getElementsByClassName('close-btn')[0];

        btn.onclick = function() {
            modal.style.display = 'block';
        }

        span.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        const resetBtn = document.getElementById('resetBtn');
        const resetModal = document.getElementById('resetModal');
        const confirmResetBtn = document.getElementById('confirmReset');
        const cancelResetBtn = document.getElementById('cancelReset');
        
        resetBtn.addEventListener('click', function() {
            resetModal.style.display = 'block';
        });
        
        cancelResetBtn.addEventListener('click', function() {
            resetModal.style.display = 'none';
        });
        
        confirmResetBtn.addEventListener('click', function() {
            resetModal.style.display = 'none';
            
            clearGameState();
            
            gameStarted = false;
            playerPosition = 0;
            player.remove();
            
            startButton.style.display = 'block';
            rollDiceButton.style.display = 'none';
            rollDiceButton.disabled = false;
            
            continueButton.style.display = 'none';
            
            instructions.classList.remove('active');
            instructions.innerHTML = '';
            
            diceResult.textContent = 'Dice: -';
            diceResult.style.display = 'none';
            
            document.getElementById('instructionSetCheckboxes').parentElement.style.display = 'block';
            document.getElementById('toyCheckboxContainer').style.display = 'block';
            document.querySelector('.prize-settings').style.display = 'block';
            
            document.querySelectorAll('#instructionSetCheckboxes input').forEach(cb => cb.checked = false);
            
            selectedSets = [];
            toySelections = {};
            toyDifficulties = {};
            
            prizeSettings = {
                minor: 25,
                major: 10,
                noPrize: 65
            };
            updateSliderDisplays();
            
            document.getElementById('toyCheckboxes').innerHTML = '<p style="color: #666; text-align: center; margin: 0;">Select instruction sets first</p>';
        });

        startButton.addEventListener('click', startGame);
        rollDiceButton.addEventListener('click', rollDice);
        
        createBoard();
        loadGameState();
    </script>
</body>
</html>
