<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snakes and Ladders</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        h1 { font-size: 3em; margin-bottom: 30px; text-shadow: 3px 3px 6px rgba(0,0,0,0.3); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        #gameContainer { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 1200px; width: 100%; }
        #board { display: grid; grid-template-columns: repeat(10, 1fr); grid-template-rows: repeat(10, 1fr); border: 4px solid #333; border-radius: 15px; margin: 0 auto 20px; width: 100%; max-width: 700px; aspect-ratio: 1; background: #fff; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); overflow: hidden; }
        .square { display: flex; justify-content: center; align-items: center; border: 1px solid rgba(0,0,0,0.1); background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); font-weight: bold; font-size: 0.9em; color: #333; position: relative; transition: all 0.3s ease; }
        .square:hover { transform: scale(1.05); z-index: 5; }
        .snake { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; }
        .snake::before { content: 'üêç'; position: absolute; font-size: 3em; opacity: 0.3; }
        .snake::after { content: attr(data-destination); position: absolute; bottom: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; font-size: 0.7em; padding: 2px 5px; border-radius: 5px; font-weight: bold; }
        .ladder { background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; }
        .ladder::before { content: 'ü™ú'; position: absolute; font-size: 3em; opacity: 0.3; }
        .ladder::after { content: attr(data-destination); position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.7); color: white; font-size: 0.7em; padding: 2px 5px; border-radius: 5px; font-weight: bold; }
        .player { width: 30px; height: 30px; background: radial-gradient(circle, #4dabf7 0%, #1864ab 100%); border-radius: 50%; position: absolute; z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.3); animation: pulse 1s ease-in-out infinite; border: 3px solid white; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        #controls { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; }
        button { padding: 15px 40px; font-size: 20px; font-weight: bold; cursor: pointer; color: white; border: none; border-radius: 50px; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        #startButton { background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); box-shadow: 0 8px 20px rgba(81,207,102,0.4); }
        #startButton:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(81,207,102,0.5); }
        #rollDice { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); box-shadow: 0 8px 20px rgba(79,172,254,0.4); }
        #rollDice:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(79,172,254,0.5); }
        button:disabled { background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%); cursor: not-allowed; box-shadow: none; }
        #diceResult { font-size: 28px; font-weight: bold; padding: 15px 30px; background: linear-gradient(135deg, #ffd93d 0%, #ffbc00 100%); border-radius: 15px; color: #333; box-shadow: 0 4px 15px rgba(255,188,0,0.3); min-width: 150px; text-align: center; }
        #instructions { margin-top: 20px; font-size: 18px; text-align: left; min-height: 80px; padding: 50px 80px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; line-height: 1.8; max-width: 900px; margin-left: auto; margin-right: auto; }
        #instructions.active { display: block; }
        #instructions img { margin: 40px 0; max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #instructions p { margin: 25px 0; font-size: 17px; line-height: 2; }
        #instructions strong { font-size: 26px; display: block; margin-bottom: 20px; text-align: center; color: #667eea; }
        #continueButton { margin-top: 15px; padding: 12px 30px; font-size: 18px; background: linear-gradient(135deg, #fa5252 0%, #e03131 100%); box-shadow: 0 6px 20px rgba(250,82,82,0.4); display: block; margin-left: auto; margin-right: auto; }
        #continueButton:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(250,82,82,0.5); }
        #buttoncontainer { margin-top: 20px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        #buttoncontainer > div { width: 100%; max-width: 400px; }
        @media (min-width: 900px) {
            #buttoncontainer { max-width: 900px; margin-left: auto; margin-right: auto; }
            #buttoncontainer > div { width: calc(50% - 7.5px); max-width: none; }
        }
        .prize-settings { margin-top: 20px; padding: 20px; background: white; border-radius: 15px; border: 2px solid #667eea; }
        .prize-settings h3 { color: #667eea; margin-bottom: 15px; text-align: center; }
        .slider-container { margin: 15px 0; }
        .slider-label { display: flex; justify-content: space-between; margin-bottom: 5px; color: #333; font-weight: bold; }
        .slider-label .percentage { color: #667eea; }
        input[type="range"] { width: 100%; height: 8px; border-radius: 5px; outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #667eea; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #667eea; cursor: pointer; }
        #minorSlider { background: linear-gradient(to right, #51cf66, #37b24d); }
        #majorSlider { background: linear-gradient(to right, #ffd93d, #ffbc00); }
        #noPrizeSlider { background: linear-gradient(to right, #adb5bd, #868e96); }
        .metronome-container { margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(79,172,254,0.3); }
        .metronome-display { font-size: 48px; font-weight: bold; color: white; text-align: center; margin: 15px 0; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .metronome-beat { width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.3); margin: 0 auto; transition: all 0.1s ease; }
        .metronome-beat.active { background: white; transform: scale(1.2); box-shadow: 0 0 20px rgba(255,255,255,0.8); }
        .metronome-btn { padding: 12px 30px; font-size: 18px; background: white; color: #4facfe; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin: 10px auto; display: block; }
        .metronome-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .metronome-btn:disabled { opacity: 0.5; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); padding-top: 60px; }
        .modal-content { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); margin: 5% auto; padding: 30px; width: 80%; max-width: 600px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); color: #333; }
        .modal-content h2 { color: #667eea; margin-bottom: 20px; }
        .modal-content p { line-height: 1.8; margin-bottom: 15px; }
        .close-btn { color: #aaa; float: right; font-size: 32px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .close-btn:hover { color: #667eea; transform: rotate(90deg); }
        #patchNotesBtn, #resetBtn { position: fixed; top: 20px; padding: 10px 20px; font-size: 14px; font-weight: 600; z-index: 10; }
        #patchNotesBtn { right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
        #resetBtn { left: 20px; background: linear-gradient(135deg, #fa5252 0%, #e03131 100%); box-shadow: 0 4px 15px rgba(250,82,82,0.4); }
        .prize-result { font-size: 2em; text-align: center; margin: 20px 0; padding: 30px; border-radius: 15px; animation: prizeReveal 0.5s ease-out; }
        @keyframes prizeReveal { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
        .prize-minor { background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; }
        .prize-major { background: linear-gradient(135deg, #ffd93d 0%, #ffbc00 100%); color: #333; }
        .prize-none { background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%); color: white; }
        .toy-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 8px 8px 20px; border-radius: 8px; transition: background 0.2s; }
        .toy-item:hover { background: #e9ecef; }
        .toy-checkbox { width: 18px; height: 18px; margin-right: 10px; accent-color: #20c997; cursor: pointer; }
        .quantity-input { width: 60px; padding: 4px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; text-align: center; font-weight: bold; margin: 0 10px; }
        #advancedSettings { margin-top: 20px; }
        .advanced-toggle { padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: bold; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .advanced-arrow { transition: transform 0.2s ease; }
        .advanced-content { max-height: 0; overflow: hidden; background: white; border-radius: 0 0 10px 10px; border: 2px solid transparent; border-top: none; transition: max-height 0.2s ease, border-color 0s 0.2s; }
        .advanced-content.open { max-height: 2000px; border: 2px solid #667eea; border-top: none; transition: max-height 0.2s ease; }
        .modifier-section { margin: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px solid #dee2e6; }
        .modifier-header { font-weight: bold; color: #667eea; font-size: 16px; margin-bottom: 15px; }
        .modifier-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .modifier-column { display: flex; flex-direction: column; align-items: center; }
        .modifier-column-header { color: #333; font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .modifier-group { display: flex; align-items: center; gap: 5px; }
        .modifier-input { width: 70px; padding: 6px; border: 2px solid #667eea; border-radius: 6px; font-size: 14px; font-weight: bold; text-align: center; }
        .percent-symbol { color: #333; font-weight: bold; }
        @media (max-width: 600px) { h1 { font-size: 2em; } #gameContainer { padding: 20px; } .square { font-size: 0.7em; } .player { width: 20px; height: 20px; } }
    </style>
</head>
<body>
    <h1>üé≤ Snakes and Ladders üé≤</h1>
    <div id="gameContainer">
        <div id="board"></div>
        <div id="controls">
            <button id="startButton">üéÆ Start Game</button>
            <button id="rollDice" style="display: none;">üé≤ Roll Dice</button>
            <div id="diceResult" style="display: none;">Dice: -</div>
        </div>
        <div id="instructions"></div>
        <div id="buttoncontainer">
            <div style="width: 100%; max-width: 400px;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">üë§ Player Name:</label>
                <input type="text" id="playerNameInput" placeholder="Enter your name" style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 10px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box;">
                <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">üì¶ Select Instruction Sets:</label>
                <div id="instructionSetCheckboxes" style="padding: 15px; background: white; border-radius: 10px; border: 2px solid #667eea;">
                    <label style="display: block; padding: 8px; cursor: pointer; color: #333;"><input type="checkbox" value="ball" style="margin-right: 10px; width: 18px; height: 18px; accent-color: #667eea;"> Ball Set üèÄ</label>
                    <label style="display: block; padding: 8px; cursor: pointer; color: #333;"><input type="checkbox" value="rope" style="margin-right: 10px; width: 18px; height: 18px; accent-color: #667eea;"> Rope Set ü™¢</label>
                    <label style="display: block; padding: 8px; cursor: pointer; color: #333;"><input type="checkbox" value="basketball_game" style="margin-right: 10px; width: 18px; height: 18px; accent-color: #667eea;"> Basketball Game Set üèÄ</label>
                </div>
                <div id="toyCheckboxContainer" style="width: 100%; margin-top: 15px;">
                    <label style="display: block; font-weight: bold; color: #333; margin-bottom: 10px;">üéØ Select Toys & Difficulty:</label>
                    <div id="toyCheckboxes" style="padding: 15px; background: white; border-radius: 10px; border: 2px solid #667eea; min-height: 60px;">
                        <p style="color: #666; text-align: center; margin: 0;">Select instruction sets first</p>
                    </div>
                </div>
                <div id="advancedSettings">
                    <div class="advanced-toggle" onclick="toggleAdvanced()">
                        <span>‚öôÔ∏è Advanced Settings</span>
                        <span id="arrow" class="advanced-arrow">‚ñº</span>
                    </div>
                    <div class="advanced-content" id="advancedContent"></div>
                </div>
            </div>
            <div style="width: 100%; max-width: 400px;">
                <div class="prize-settings">
                    <h3>üéÅ Prize Probabilities</h3>
                    <div class="slider-container">
                        <div class="slider-label"><span>üéâ Minor:</span><span class="percentage" id="minorPercent">25%</span></div>
                        <input type="range" id="minorSlider" min="0" max="100" value="25">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label"><span>üèÜ Major:</span><span class="percentage" id="majorPercent">10%</span></div>
                        <input type="range" id="majorSlider" min="0" max="100" value="10">
                    </div>
                    <div class="slider-container">
                        <div class="slider-label"><span>‚ùå None:</span><span class="percentage" id="noPrizePercent">65%</span></div>
                        <input type="range" id="noPrizeSlider" min="0" max="100" value="65">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <button id="resetBtn">üîÑ Reset</button>
    <button id="patchNotesBtn">üìã Notes</button>
    <div id="patchNotesModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>üìã Patch Notes</h2>
            <p><strong>Ver 0.5:</strong> Modifier system with add/remove chances & toy quantities</p>
        </div>
    </div>
    <div id="resetModal" class="modal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è Reset Game?</h2>
            <p style="font-size: 18px; margin: 20px 0;">You will lose all progress!</p>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button id="confirmReset" style="padding: 12px 30px; font-size: 16px; background: linear-gradient(135deg, #fa5252 0%, #e03131 100%); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">Yes</button>
                <button id="cancelReset" style="padding: 12px 30px; font-size: 16px; background: linear-gradient(135deg, #adb5bd 0%, #868e96 100%); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;">Cancel</button>
            </div>
        </div>
    </div>
    <script>
const board=document.getElementById('board'),diceResult=document.getElementById('diceResult'),instructions=document.getElementById('instructions'),startButton=document.getElementById('startButton'),rollDiceButton=document.getElementById('rollDice'),continueButton=document.createElement('button');
continueButton.id="continueButton";continueButton.textContent="‚úì Complete";
const boardSize=10,totalSquares=100,player=document.createElement('div');
player.classList.add('player');
const snakes={16:6,47:26,49:11,56:53,62:19,64:60,87:24,93:73,95:75,98:78},ladders={1:38,4:14,9:31,21:42,28:84,36:44,51:67,71:91,80:99};
let audioContext=null,currentMetronomeTask=null,toyDifficulties={},gameStarted=false,playerPosition=0,selectedSets=[],toySelections={},prizeSettings={minor:25,major:10,noPrize:65},toyQuantities={},toyModifiers={},advancedSettingsOpen=false,playerName='';

// Body part capacity system
const bodyParts = {
    leftHand: { name: "Left Hand", capacity: 5, occupied: 0, items: [] },
    rightHand: { name: "Right Hand", capacity: 5, occupied: 0, items: [] },
    bothHands: { name: "Both Hands", capacity: 10, occupied: 0, items: [] },
    leftFoot: { name: "Left Foot", capacity: 3, occupied: 0, items: [] },
    rightFoot: { name: "Right Foot", capacity: 3, occupied: 0, items: [] },
    head: { name: "Head", capacity: 3, occupied: 0, items: [] },
    back: { name: "Back", capacity: 8, occupied: 0, items: [] }
};

// Toy size/weight - how much capacity each toy takes
const toyCapacity = {
    basketball: 5,
    soccerball: 5,
    jumprope: 2,
    climbingrope: 8
    // Note: basketball_hoop is NOT in this list, so it's not wearable
};

// Helper to check if a toy is wearable
function isToyWearable(toyId) {
    return toyCapacity.hasOwnProperty(toyId);
}

// Current body part state - what's being held where
let bodyPartState = JSON.parse(JSON.stringify(bodyParts)); // Deep copy for reset

// Dynamic task conditions helper
function getTaskConditions() {
    return {
        // Get player name
        name: playerName || 'Player',
        // Check if holding a specific toy
        isHolding: (toyId) => {
            for (const part of Object.values(bodyPartState)) {
                if (part.items.includes(toyId)) return true;
            }
            return false;
        },
        // Get which body parts are holding a toy
        getBodyPartsHolding: (toyId) => {
            const parts = [];
            for (const [partKey, part] of Object.entries(bodyPartState)) {
                if (part.items.includes(toyId)) {
                    parts.push({ key: partKey, name: part.name });
                }
            }
            return parts;
        },
        // Check if a body part is occupied
        isBodyPartOccupied: (bodyPartKey) => {
            return bodyPartState[bodyPartKey] && bodyPartState[bodyPartKey].occupied > 0;
        },
        // Check if a body part has capacity for a toy
        canBodyPartHold: (bodyPartKey, toyId) => {
            return canAddToyToBodyPart(bodyPartKey, toyId);
        },
        // Get all held items
        getAllHeldItems: () => {
            const items = [];
            for (const part of Object.values(bodyPartState)) {
                items.push(...part.items);
            }
            return items;
        },
        // Get body part state
        getBodyPartState: () => bodyPartState
    };
}

const instructionSets={ball:{name:"Ball Set",toys:[{id:"basketball",name:"Basketball üèÄ"},{id:"soccerball",name:"Soccer Ball ‚öΩ"}],tasks:{basketball:[{getDifficulty:d=>`<strong>Basketball Dribbling</strong><p>Work on your ball handling! Bounce the ball ${d=='easy'?5:d=='medium'?10:15} times in a row without losing control.</p><img src="https://picsum.photos/seed/bb1/800/600"/>`},{type:'metronome',getDifficulty:d=>d=='easy'?8:d=='medium'?10:15},{getDifficulty:d=>`<strong>Ball Spinning</strong><p>Show off your skills! Spin the basketball on your finger for ${d=='easy'?3:d=='medium'?5:8} seconds.</p><img src="https://picsum.photos/seed/bb2/800/600"/>`},{
            canSelect: (conditions) => {
                // Can always select this task
                return true;
            },
            getDifficulty: (d, conditions) => {
                const isHoldingBasketball = conditions.isHolding('basketball');
                const holdingParts = conditions.getBodyPartsHolding('basketball');
                
                const times = d=='easy'?3:d=='medium'?5:10;
                
                if (isHoldingBasketball) {
                    const partNames = holdingParts.map(p => p.name).join(' and ');
                    return `<strong>Around the Waist</strong><p>${conditions.name}, pass the basketball (that you are already holding in your ${partNames}) around your waist ${times} times to improve coordination.</p><img src="https://picsum.photos/seed/bb3/800/600"/>`;
                } else {
                    return `<strong>Around the Waist</strong><p>${conditions.name}, pass the basketball around your waist ${times} times to improve coordination.</p><img src="https://picsum.photos/seed/bb3/800/600"/>`;
                }
            }
        }],soccerball:[{getDifficulty:d=>`<strong>Kick the Ball</strong><p>Practice your kicking! Kick the soccer ball ${d=='easy'?3:d=='medium'?5:10} times.</p><img src="https://picsum.photos/seed/sc1/800/600"/>`},{getDifficulty:d=>`<strong>Juggling Challenge</strong><p>Keep the ball in the air! Juggle the soccer ball ${d=='easy'?2:d=='medium'?3:5} times without it touching the ground.</p><img src="https://picsum.photos/seed/sc2/800/600"/>`},{getDifficulty:d=>`<strong>Roll in a Circle</strong><p>Use your foot to roll the soccer ball in a circle ${d=='easy'?3:d=='medium'?5:8} times.</p><img src="https://picsum.photos/seed/sc3/800/600"/>`}]}},rope:{name:"Rope Set",toys:[{id:"jumprope",name:"Jump Rope ü™¢"},{id:"climbingrope",name:"Climbing Rope üßó"}],tasks:{jumprope:[{getDifficulty:d=>`<strong>Jump Rope</strong><p>Get your heart pumping! Jump rope ${d=='easy'?10:d=='medium'?15:25} times in a row.</p><img src="https://picsum.photos/seed/jr1/800/600"/>`},{type:'redlight',getDifficulty:d=>d=='easy'?15000:d=='medium'?20000:30000},{getDifficulty:d=>`<strong>Criss-Cross Jumps</strong><p>Advanced move! Do ${d=='easy'?3:d=='medium'?5:8} criss-cross jumps by crossing your arms while jumping.</p><img src="https://picsum.photos/seed/jr2/800/600"/>`},{getDifficulty:d=>`<strong>Backwards Jump</strong><p>Challenge yourself! Jump rope backwards ${d=='easy'?5:d=='medium'?10:15} times.</p><img src="https://picsum.photos/seed/jr3/800/600"/>`}],climbingrope:[{getDifficulty:d=>`<strong>Climb the Rope</strong><p>Build your strength! Climb up the rope ${d=='easy'?'2 feet':d=='medium'?'3 feet':'5 feet'}.</p><img src="https://picsum.photos/seed/cr1/800/600"/>`},{getDifficulty:d=>`<strong>Hanging Challenge</strong><p>Test your grip! Hang from the climbing rope for ${d=='easy'?5:d=='medium'?10:15} seconds with your feet off the ground.</p><img src="https://picsum.photos/seed/cr2/800/600"/>`},{getDifficulty:d=>`<strong>Pull-Ups</strong><p>Show your upper body strength! Do ${d=='easy'?2:d=='medium'?3:5} rope pull-ups.</p><img src="https://picsum.photos/seed/cr3/800/600"/>`}]}},basketball_game:{name:"Basketball Game",toys:[{id:"basketball_hoop",name:"Basketball with Hoop üèÄ"}],tasks:{basketball_hoop:[{getDifficulty:d=>`<strong>Free Throw Challenge</strong><p>Aim carefully! Make ${d=='easy'?2:d=='medium'?3:5} baskets from the free throw line.</p><img src="https://picsum.photos/seed/hp1/800/600"/>`},{getDifficulty:d=>`<strong>Layup Shot</strong><p>Get close and score! Make ${d=='easy'?1:d=='medium'?2:3} layup shot${d=='easy'?'':'s'}.</p><img src="https://picsum.photos/seed/hp2/800/600"/>`},{getDifficulty:d=>`<strong>Three-Pointer</strong><p>From downtown! Try to make ${d=='easy'?1:d=='medium'?2:3} shot${d=='easy'?'':'s'} from the 3-point line.</p><img src="https://picsum.photos/seed/hp3/800/600"/>`}]}}};

function saveGameState(){localStorage.setItem('snakesLaddersGameState',JSON.stringify({gameStarted,playerPosition,selectedSets,toySelections,toyDifficulties,prizeSettings,toyQuantities,toyModifiers,advancedSettingsOpen,bodyPartState,playerName,diceResultText:diceResult.textContent,currentInstruction:instructions.innerHTML,instructionsActive:instructions.classList.contains('active'),lastTaskInfo:window.lastTaskInfo||null}))}

function loadGameState(){const saved=localStorage.getItem('snakesLaddersGameState');if(!saved)return false;try{const gs=JSON.parse(saved);gameStarted=gs.gameStarted;playerPosition=gs.playerPosition;selectedSets=gs.selectedSets||[];toySelections=gs.toySelections||{};toyDifficulties=gs.toyDifficulties||{};toyQuantities=gs.toyQuantities||{};toyModifiers=gs.toyModifiers||{};advancedSettingsOpen=gs.advancedSettingsOpen||false;playerName=gs.playerName||'';if(gs.bodyPartState){bodyPartState=gs.bodyPartState}if(gs.prizeSettings){prizeSettings=gs.prizeSettings;updateSliderDisplays(true)}if(gameStarted){startButton.style.display='none';rollDiceButton.style.display='block';diceResult.style.display='block';diceResult.textContent=gs.diceResultText||'Dice: -';document.getElementById('instructionSetCheckboxes').parentElement.style.display='none';document.getElementById('toyCheckboxContainer').style.display='none';document.getElementById('advancedSettings').style.display='none';document.querySelector('.prize-settings').style.display='none';createBoard();if(playerPosition>0){const sq=document.getElementById(`square-${playerPosition}`);if(sq)sq.appendChild(player)}if(gs.lastTaskInfo&&gs.lastTaskInfo.taskType){window.lastTaskInfo=gs.lastTaskInfo;instructions.classList.add('active');if(gs.lastTaskInfo.taskType==='metronome'){currentMetronomeTask=createMetronomeTask(gs.lastTaskInfo.beatCount);instructions.innerHTML='';instructions.appendChild(currentMetronomeTask.element)}else if(gs.lastTaskInfo.taskType==='redlight'){currentMetronomeTask=createRedLightGreenLightTask(gs.lastTaskInfo.duration);instructions.innerHTML='';instructions.appendChild(currentMetronomeTask.element)}else if(gs.currentInstruction){instructions.innerHTML=gs.currentInstruction}}else if(gs.currentInstruction&&gs.currentInstruction.trim()!==''){instructions.innerHTML=gs.currentInstruction;if(gs.instructionsActive)instructions.classList.add('active')}}else{document.getElementById('playerNameInput').value=playerName;updateToyCheckboxes();if(advancedSettingsOpen&&gs.advancedSettingsOpen){const content=document.getElementById('advancedContent');const arrow=document.getElementById('arrow');content.classList.add('open');arrow.style.transform='rotate(180deg)';updateAdvancedSettings()}}return true}catch(e){console.error('Load error:',e);return false}}

function updateSliderDisplays(skipSave=false){prizeSettings.minor=Math.round(prizeSettings.minor*10)/10;prizeSettings.major=Math.round(prizeSettings.major*10)/10;prizeSettings.noPrize=Math.round(prizeSettings.noPrize*10)/10;document.getElementById('minorPercent').textContent=prizeSettings.minor.toFixed(1)+'%';document.getElementById('majorPercent').textContent=prizeSettings.major.toFixed(1)+'%';document.getElementById('noPrizePercent').textContent=prizeSettings.noPrize.toFixed(1)+'%';document.getElementById('minorSlider').value=prizeSettings.minor;document.getElementById('majorSlider').value=prizeSettings.major;document.getElementById('noPrizeSlider').value=prizeSettings.noPrize;if(!skipSave)saveGameState()}

document.getElementById('minorSlider').addEventListener('input',function(){const newMinor=Math.round(parseFloat(this.value)),maxAllowed=100-Math.round(prizeSettings.major);prizeSettings.minor=newMinor>maxAllowed?maxAllowed:newMinor;prizeSettings.noPrize=100-prizeSettings.minor-prizeSettings.major;updateSliderDisplays()});

document.getElementById('majorSlider').addEventListener('input',function(){const newMajor=Math.round(parseFloat(this.value)),maxAllowed=100-Math.round(prizeSettings.minor);prizeSettings.major=newMajor>maxAllowed?maxAllowed:newMajor;prizeSettings.noPrize=100-prizeSettings.minor-prizeSettings.major;updateSliderDisplays()});

document.getElementById('noPrizeSlider').addEventListener('input',function(){const newNoPrize=Math.round(parseFloat(this.value)),available=100-newNoPrize,currentTotal=Math.round(prizeSettings.minor)+Math.round(prizeSettings.major);if(available<currentTotal&&currentTotal>0){const reduction=currentTotal-available,minorProp=prizeSettings.minor/currentTotal,majorProp=prizeSettings.major/currentTotal;prizeSettings.minor=Math.max(0,Math.round(prizeSettings.minor-reduction*minorProp));prizeSettings.major=Math.max(0,Math.round(prizeSettings.major-reduction*majorProp))}else if(available>currentTotal){const increase=available-currentTotal,half=increase/2;prizeSettings.minor=Math.round(prizeSettings.minor+half);prizeSettings.major=Math.round(prizeSettings.major+half)}prizeSettings.noPrize=newNoPrize;updateSliderDisplays()});

function determinePrize(){const roll=Math.random()*100;return roll<prizeSettings.major?'major':roll<prizeSettings.major+prizeSettings.minor?'minor':'none'}

function displayPrizeResult(prize){return prize==='major'?'<div class="prize-result prize-major">üèÜ MAJOR PRIZE! üèÜ<br>Congratulations!</div>':prize==='minor'?'<div class="prize-result prize-minor">üéâ Minor Prize! üéâ<br>Nice job!</div>':'<div class="prize-result prize-none">‚ùå No Prize<br>Better luck next time!</div>'}

function toggleAdvanced(){const content=document.getElementById('advancedContent'),arrow=document.getElementById('arrow');if(advancedSettingsOpen){content.classList.remove('open');arrow.style.transform='rotate(0deg)';advancedSettingsOpen=false}else{advancedSettingsOpen=true;content.classList.add('open');arrow.style.transform='rotate(180deg)';updateAdvancedSettings()}saveGameState()}
window.toggleAdvanced=toggleAdvanced;

function updateAdvancedSettings(){const currentSelectedSets=Array.from(document.querySelectorAll('#instructionSetCheckboxes input:checked')).map(cb=>cb.value);const currentSetToys=new Set();currentSelectedSets.forEach(setId=>{if(instructionSets[setId]){instructionSets[setId].toys.forEach(toy=>{currentSetToys.add(`${setId}_${toy.id}`)})}});const selectedToys=Object.keys(toyQuantities).filter(k=>toyQuantities[k]>0&&currentSetToys.has(k));const content=document.getElementById('advancedContent');content.innerHTML='';if(selectedToys.length===0){const emptyMsg=document.createElement('div');emptyMsg.style.cssText='padding: 20px; text-align: center; color: #666;';emptyMsg.textContent='No toys selected';content.appendChild(emptyMsg);return}selectedToys.forEach(toyKey=>{let foundSet=null,foundToy=null;for(const[setId,setData]of Object.entries(instructionSets)){for(const toy of setData.toys){if(`${setId}_${toy.id}`===toyKey){foundSet=setData;foundToy=toy;break}}if(foundToy)break}if(!foundSet||!foundToy)return;const section=document.createElement('div');section.className='modifier-section';const header=document.createElement('div');header.className='modifier-header';header.textContent=foundToy.name;section.appendChild(header);const controls=document.createElement('div');controls.className='modifier-controls';const toyId=toyKey.split('_')[1];const isWearable=isToyWearable(toyId);if(isWearable){controls.style.gridTemplateColumns='1fr 1fr 1fr'}else{controls.style.gridTemplateColumns='1fr'}if(isWearable){const addColumn=document.createElement('div');addColumn.className='modifier-column';const addHeader=document.createElement('div');addHeader.className='modifier-column-header';addHeader.textContent='Add Chance';addColumn.appendChild(addHeader);const addGroup=document.createElement('div');addGroup.className='modifier-group';const addInput=document.createElement('input');addInput.type='number';addInput.className='modifier-input';addInput.id=`add_${toyKey}`;addInput.min='0';addInput.max='100';addInput.value=toyModifiers[toyKey]?toyModifiers[toyKey].addChance:25;addGroup.appendChild(addInput);const addPercent=document.createElement('span');addPercent.className='percent-symbol';addPercent.textContent='%';addGroup.appendChild(addPercent);addColumn.appendChild(addGroup);controls.appendChild(addColumn);const removeColumn=document.createElement('div');removeColumn.className='modifier-column';const removeHeader=document.createElement('div');removeHeader.className='modifier-column-header';removeHeader.textContent='Remove Chance';removeColumn.appendChild(removeHeader);const removeGroup=document.createElement('div');removeGroup.className='modifier-group';const removeInput=document.createElement('input');removeInput.type='number';removeInput.className='modifier-input';removeInput.id=`remove_${toyKey}`;removeInput.min='0';removeInput.max='100';removeInput.value=toyModifiers[toyKey]?toyModifiers[toyKey].removeChance:15;removeGroup.appendChild(removeInput);const removePercent=document.createElement('span');removePercent.className='percent-symbol';removePercent.textContent='%';removeGroup.appendChild(removePercent);removeColumn.appendChild(removeGroup);controls.appendChild(removeColumn)};const difficultyColumn=document.createElement('div');difficultyColumn.className='modifier-column';const difficultyHeader=document.createElement('div');difficultyHeader.className='modifier-column-header';difficultyHeader.textContent='Task Difficulty';difficultyColumn.appendChild(difficultyHeader);const difficultySelect=document.createElement('select');difficultySelect.className='modifier-input';difficultySelect.id=`adv_difficulty_${toyKey}`;difficultySelect.style.cssText='width: auto; padding: 6px 12px; cursor: pointer;';['easy','medium','hard'].forEach(level=>{const opt=document.createElement('option');opt.value=level;opt.textContent=level=='easy'?'Easy üòä':level=='medium'?'Medium üòê':'Hard üò§';if(level==(toyDifficulties[toyKey]||'medium'))opt.selected=true;difficultySelect.appendChild(opt)});difficultyColumn.appendChild(difficultySelect);controls.appendChild(difficultyColumn);section.appendChild(controls);content.appendChild(section);if(isWearable){document.getElementById(`add_${toyKey}`).oninput=e=>{const val=Math.max(0,Math.min(100,parseInt(e.target.value)||0));e.target.value=val;if(!toyModifiers[toyKey])toyModifiers[toyKey]={addChance:25,removeChance:15};toyModifiers[toyKey].addChance=val;const mainDifficultySelect=document.getElementById(`difficulty_${toyKey}`);if(mainDifficultySelect){const customOpt=Array.from(mainDifficultySelect.options).find(o=>o.value==='custom');if(customOpt){customOpt.style.display='block';mainDifficultySelect.value='custom'}}saveGameState()};document.getElementById(`remove_${toyKey}`).oninput=e=>{const val=Math.max(0,Math.min(100,parseInt(e.target.value)||0));e.target.value=val;if(!toyModifiers[toyKey])toyModifiers[toyKey]={addChance:25,removeChance:15};toyModifiers[toyKey].removeChance=val;const mainDifficultySelect=document.getElementById(`difficulty_${toyKey}`);if(mainDifficultySelect){const customOpt=Array.from(mainDifficultySelect.options).find(o=>o.value==='custom');if(customOpt){customOpt.style.display='block';mainDifficultySelect.value='custom'}}saveGameState()}}document.getElementById(`adv_difficulty_${toyKey}`).onchange=e=>{toyDifficulties[toyKey]=e.target.value;const mainDifficultySelect=document.getElementById(`difficulty_${toyKey}`);if(mainDifficultySelect){const customOpt=Array.from(mainDifficultySelect.options).find(o=>o.value==='custom');if(customOpt){customOpt.style.display='block';mainDifficultySelect.value='custom'}}saveGameState()}})}

function applyPreset(toyKey,difficulty){const presets={easy:{addChance:10,removeChance:30},medium:{addChance:25,removeChance:15},hard:{addChance:50,removeChance:5}};if(presets[difficulty]){toyModifiers[toyKey]={...presets[difficulty]};toyDifficulties[toyKey]=difficulty;updateAdvancedSettings();saveGameState()}}

// Body part management functions
function canAddToyToBodyPart(bodyPart, toyId) {
    const toySize = toyCapacity[toyId] || 0;
    const available = bodyPartState[bodyPart].capacity - bodyPartState[bodyPart].occupied;
    return available >= toySize;
}

function addToyToBodyPart(bodyPart, toyId) {
    const toySize = toyCapacity[toyId] || 0;
    if (canAddToyToBodyPart(bodyPart, toyId)) {
        bodyPartState[bodyPart].occupied += toySize;
        bodyPartState[bodyPart].items.push(toyId);
        saveGameState();
        return true;
    }
    return false;
}

function removeToyFromBodyPart(bodyPart, toyId) {
    const index = bodyPartState[bodyPart].items.indexOf(toyId);
    if (index > -1) {
        const toySize = toyCapacity[toyId] || 0;
        bodyPartState[bodyPart].occupied -= toySize;
        bodyPartState[bodyPart].items.splice(index, 1);
        saveGameState();
        return true;
    }
    return false;
}

function isBodyPartFull(bodyPart) {
    return bodyPartState[bodyPart].occupied >= bodyPartState[bodyPart].capacity;
}

function getBodyPartStatus(bodyPart) {
    return {
        occupied: bodyPartState[bodyPart].occupied,
        capacity: bodyPartState[bodyPart].capacity,
        available: bodyPartState[bodyPart].capacity - bodyPartState[bodyPart].occupied,
        items: [...bodyPartState[bodyPart].items],
        isFull: isBodyPartFull(bodyPart)
    };
}

// Add/Remove task system
function shouldRollAddTask(toyKey) {
    const modifier = toyModifiers[toyKey];
    if (!modifier) return false;
    const roll = Math.random() * 100;
    return roll < modifier.addChance;
}

function shouldRollRemoveTask(toyKey) {
    const modifier = toyModifiers[toyKey];
    if (!modifier) return false;
    const roll = Math.random() * 100;
    return roll < modifier.removeChance;
}

function getAvailableBodyPartsForToy(toyId) {
    const toySize = toyCapacity[toyId] || 0;
    const available = [];
    
    // Check which body parts can hold this toy
    for (const [partKey, part] of Object.entries(bodyPartState)) {
        const availableSpace = part.capacity - part.occupied;
        if (availableSpace >= toySize) {
            available.push({
                key: partKey,
                name: part.name,
                available: availableSpace
            });
        }
    }
    
    return available;
}

function getBodyPartsHoldingToy(toyId) {
    const holding = [];
    
    for (const [partKey, part] of Object.entries(bodyPartState)) {
        if (part.items.includes(toyId)) {
            holding.push({
                key: partKey,
                name: part.name
            });
        }
    }
    
    return holding;
}

function createAddToyTask(toyKey, toyName) {
    const toyId = toyKey.split('_')[1];
    
    // Count how many of this toy are currently being held
    let heldCount = 0;
    for (const part of Object.values(bodyPartState)) {
        heldCount += part.items.filter(item => item === toyId).length;
    }
    
    // Check if we have any available (not being held)
    const totalAvailable = toyQuantities[toyKey] || 0;
    if (heldCount >= totalAvailable) {
        return null; // All copies of this toy are already being held
    }
    
    const availableParts = getAvailableBodyPartsForToy(toyId);
    
    if (availableParts.length === 0) {
        return null; // No room anywhere
    }
    
    // Pick a random available body part
    const targetPart = availableParts[Math.floor(Math.random() * availableParts.length)];
    
    return {
        type: 'add',
        toyId: toyId,
        toyKey: toyKey,
        toyName: toyName,
        bodyPart: targetPart.key,
        bodyPartName: targetPart.name,
        execute: function() {
            return addToyToBodyPart(this.bodyPart, this.toyId);
        },
        getHTML: function() {
            return `<strong>üì• Pick Up Task</strong><p>Pick up the ${this.toyName} and hold it in your ${this.bodyPartName}.</p><p style="color: #666; font-size: 0.9em;">This toy will stay with you until a task tells you to put it down.</p>`;
        }
    };
}

function createRemoveToyTask(toyKey, toyName) {
    const toyId = toyKey.split('_')[1];
    const holdingParts = getBodyPartsHoldingToy(toyId);
    
    if (holdingParts.length === 0) {
        return null; // Not holding this toy
    }
    
    // Pick a random body part that's holding it
    const targetPart = holdingParts[Math.floor(Math.random() * holdingParts.length)];
    
    return {
        type: 'remove',
        toyId: toyId,
        toyKey: toyKey,
        toyName: toyName,
        bodyPart: targetPart.key,
        bodyPartName: targetPart.name,
        execute: function() {
            return removeToyFromBodyPart(this.bodyPart, this.toyId);
        },
        getHTML: function() {
            return `<strong>üì§ Put Down Task</strong><p>Put down the ${this.toyName} from your ${this.bodyPartName}.</p><p style="color: #666; font-size: 0.9em;">You can now use this body part freely again.</p>`;
        }
    };
}

function rollForAddRemoveTasks() {
    const addTasks = [];
    const removeTasks = [];
    
    // Check all toys with quantities > 0
    for (const [toyKey, quantity] of Object.entries(toyQuantities)) {
        if (quantity > 0) {
            const toyId = toyKey.split('_')[1];
            
            // Only process wearable toys
            if (!isToyWearable(toyId)) continue;
            
            // Check for add task
            if (shouldRollAddTask(toyKey)) {
                const setId = toyKey.split('_')[0];
                let toyName = toyId;
                
                // Find toy name
                if (instructionSets[setId]) {
                    const toy = instructionSets[setId].toys.find(t => t.id === toyId);
                    if (toy) toyName = toy.name;
                }
                
                const task = createAddToyTask(toyKey, toyName);
                if (task) addTasks.push(task);
            }
            
            // Check for remove task
            if (shouldRollRemoveTask(toyKey)) {
                const setId = toyKey.split('_')[0];
                let toyName = toyId;
                
                // Find toy name
                if (instructionSets[setId]) {
                    const toy = instructionSets[setId].toys.find(t => t.id === toyId);
                    if (toy) toyName = toy.name;
                }
                
                const task = createRemoveToyTask(toyKey, toyName);
                if (task) removeTasks.push(task);
            }
        }
    }
    
    // Pick one random task from either adds or removes if any exist
    const allTasks = [...addTasks, ...removeTasks];
    if (allTasks.length > 0) {
        return allTasks[Math.floor(Math.random() * allTasks.length)];
    }
    
    return null;
}

function createMetronomeTask(beatCount){let metronomeInterval=null,countdownInterval=null,isComplete=false;const wrapper=document.createElement('div');const textDiv=document.createElement('div');textDiv.innerHTML='<strong>üèÄ Bounce to the Beat!</strong><p>Bounce the basketball in rhythm.</p>';wrapper.appendChild(textDiv);const container=document.createElement('div');container.className='metronome-container';container.innerHTML=`<div class="metronome-beat" id="metronomeBeat"></div><div class="metronome-display" id="metronomeDisplay">Ready?</div><button class="metronome-btn" id="startMetronome">‚ñ∂Ô∏è Start</button>`;wrapper.appendChild(container);const startBtn=container.querySelector('#startMetronome'),display=container.querySelector('#metronomeDisplay'),beat=container.querySelector('#metronomeBeat');startBtn.addEventListener('click',function(){startBtn.disabled=true;let count=3;display.textContent=count;countdownInterval=setInterval(()=>{count--;if(count>0){display.textContent=count}else{clearInterval(countdownInterval);display.textContent="Bounce!";startMetronome()}},1000)});function playBeep(){if(!audioContext){audioContext=new(window.AudioContext||window.webkitAudioContext)()}const osc=audioContext.createOscillator(),gain=audioContext.createGain();osc.connect(gain);gain.connect(audioContext.destination);osc.type='sine';osc.frequency.value=440;gain.gain.setValueAtTime(0.3,audioContext.currentTime);gain.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.05);osc.start(audioContext.currentTime);osc.stop(audioContext.currentTime+0.05)}function startMetronome(){let beatsLeft=beatCount;const bpm=100,interval=60000/bpm;function doBeat(){beatsLeft--;beat.classList.add('active');playBeep();display.textContent=`${beatsLeft} bounces left`;setTimeout(()=>{beat.classList.remove('active')},100);if(beatsLeft<=0){clearInterval(metronomeInterval);display.textContent="Complete! ‚úì";isComplete=true;continueButton.disabled=false;continueButton.style.opacity='1'}}doBeat();metronomeInterval=setInterval(doBeat,interval);continueButton.disabled=true;continueButton.style.opacity='0.5'}return{element:wrapper,isComplete:()=>isComplete,cleanup:()=>{if(metronomeInterval)clearInterval(metronomeInterval);if(countdownInterval)clearInterval(countdownInterval)},hasStarted:()=>startBtn.disabled}}

function createRedLightGreenLightTask(totalDuration){let gameInterval=null,countdownInterval=null,isComplete=false,timeRemaining=totalDuration;const imagePatterns=[{image:'chair.jpg',name:'Chair',type:'red'},{image:'broom.jpg',name:'Broom',type:'green'},{image:'hat.jpg',name:'Hat',type:'red'},{image:'ball.jpg',name:'Ball',type:'green'},{image:'books.jpg',name:'Books',type:'red'},{image:'car.jpg',name:'Car',type:'green'},{image:'tree.jpg',name:'Tree',type:'red'},{image:'guitar.jpg',name:'Guitar',type:'green'},{image:'apple.jpg',name:'Apple',type:'red'},{image:'bike.jpg',name:'Bike',type:'green'}];const lightPatterns=[{duration:2000},{duration:1500},{duration:1500},{duration:2500},{duration:1000},{duration:3000},{duration:2000},{duration:1500}];const container=document.createElement('div');container.className='metronome-container';container.style.background='linear-gradient(135deg, #845ef7 0%, #5f3dc4 100%)';container.innerHTML=`<div><strong>üö¶ Red Light, Green Light!</strong></div><p style="color: white; margin: 10px 0;">üü¢ GREEN = Jump! | üî¥ RED = Stop!</p><div style="background: rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 20px; margin: 15px 0;"><div style="width: 150px; height: 150px; margin: 0 auto 10px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden;" id="imageContainer"><div style="font-size: 3em; color: #845ef7;">üö¶</div></div><div style="color: white; font-size: 1.2em; font-weight: bold;" id="imageName">Get Ready!</div></div><div style="width: 120px; height: 120px; border-radius: 50%; background: rgba(255, 255, 255, 0.3); margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 4em; transition: all 0.3s ease;" id="lightIndicator">‚è∏Ô∏è</div><div class="metronome-display" id="lightDisplay">Press Start!</div><div style="color: white; font-size: 18px; margin: 10px 0;" id="timeDisplay"></div><button class="metronome-btn" id="startRedLight">‚ñ∂Ô∏è Start</button>`;const startBtn=container.querySelector('#startRedLight'),display=container.querySelector('#lightDisplay'),lightIndicator=container.querySelector('#lightIndicator'),timeDisplay=container.querySelector('#timeDisplay'),imageContainer=container.querySelector('#imageContainer'),imageName=container.querySelector('#imageName');startBtn.addEventListener('click',function(){startBtn.disabled=true;let count=3;imageContainer.innerHTML=`<div style="font-size: 4em; color: #845ef7;">${count}</div>`;imageName.textContent='Starting...';lightIndicator.textContent='‚è≥';display.textContent='Get ready...';countdownInterval=setInterval(()=>{count--;if(count>0){imageContainer.innerHTML=`<div style="font-size: 4em; color: #845ef7;">${count}</div>`}else{clearInterval(countdownInterval);startGame()}},1000)});function startGame(){let currentImageIndex=0,currentPatternIndex=0;function showNextLight(){if(timeRemaining<=0){clearInterval(gameInterval);display.textContent="Game Complete! ‚úì";lightIndicator.textContent="‚úì";lightIndicator.style.background="linear-gradient(135deg, #51cf66 0%, #37b24d 100%)";imageContainer.innerHTML='<div style="font-size: 4em; color: #51cf66;">üéâ</div>';imageName.textContent="Great Job!";timeDisplay.textContent="";isComplete=true;continueButton.disabled=false;continueButton.style.opacity='1';return}const currentImage=imagePatterns[currentImageIndex],pattern=lightPatterns[currentPatternIndex];imageContainer.innerHTML=`<img src="${currentImage.image}" alt="${currentImage.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'font-size: 3em; color: #845ef7;\\'>${currentImage.name[0]}</div>';">`;imageName.textContent=currentImage.name;lightIndicator.textContent=currentImage.type==='green'?'üü¢':'üî¥';display.textContent=currentImage.type==='green'?'GREEN LIGHT - JUMP!':'RED LIGHT - STOP!';if(currentImage.type==='green'){lightIndicator.style.background='linear-gradient(135deg, #51cf66 0%, #37b24d 100%)';lightIndicator.style.transform='scale(1.2)'}else{lightIndicator.style.background='linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%)';lightIndicator.style.transform='scale(1)'}const displayDuration=Math.min(pattern.duration,timeRemaining);timeRemaining-=displayDuration;timeDisplay.textContent=`${Math.ceil(timeRemaining/1000)}s remaining`;setTimeout(()=>{currentImageIndex++;if(currentImageIndex>=imagePatterns.length){currentImageIndex=0}currentPatternIndex++;if(currentPatternIndex>=lightPatterns.length){currentPatternIndex=0}showNextLight()},displayDuration)}continueButton.disabled=true;continueButton.style.opacity='0.5';showNextLight()}return{element:container,isComplete:()=>isComplete,cleanup:()=>{if(gameInterval)clearInterval(gameInterval);if(countdownInterval)clearInterval(countdownInterval)},hasStarted:()=>startBtn.disabled}}

function createBoard(){let reverse=false,currentNumber=1;for(let row=0;row<boardSize;row++){for(let col=0;col<boardSize;col++){const actualCol=reverse?boardSize-col-1:col,square=document.createElement('div');square.classList.add('square');square.textContent=currentNumber;square.id=`square-${currentNumber}`;square.style.gridRow=boardSize-row;square.style.gridColumn=actualCol+1;if(snakes[currentNumber]){square.classList.add('snake');square.setAttribute('data-destination','‚Üì'+snakes[currentNumber])}else if(ladders[currentNumber]){square.classList.add('ladder');square.setAttribute('data-destination','‚Üë'+ladders[currentNumber])}board.appendChild(square);currentNumber++}reverse=!reverse}}

function animatePlayer(start,end,callback,instant=false){if(instant){const targetSquare=document.getElementById(`square-${end}`);if(targetSquare)targetSquare.appendChild(player);if(callback)callback();return}let current=start;const step=current<end?1:-1;const interval=setInterval(()=>{current+=step;const currentSquare=document.getElementById(`square-${current}`);if(currentSquare)currentSquare.appendChild(player);if(current===end){clearInterval(interval);if(callback)callback()}},200)}

function getSelectedToys(){const allToys=[];document.querySelectorAll('#toyCheckboxes input[type="checkbox"]:checked').forEach(cb=>{const toyKey=`${cb.dataset.setId}_${cb.value}`;allToys.push({toyId:cb.value,setId:cb.dataset.setId,difficulty:toyDifficulties[toyKey]||'medium'})});return allToys}

function displayRandomInstruction(){const toys=getSelectedToys();if(currentMetronomeTask){currentMetronomeTask.cleanup();currentMetronomeTask=null}if(toys.length===0){instructions.classList.add('active');instructions.innerHTML="<div>üéØ Select instruction sets and toys to get started!</div>";window.lastTaskInfo=null;return}const randomToyObj=toys[Math.floor(Math.random()*toys.length)],tasks=instructionSets[randomToyObj.setId].tasks[randomToyObj.toyId];if(!tasks||tasks.length===0){instructions.classList.add('active');instructions.innerHTML="<div>No tasks available for this toy!</div>";window.lastTaskInfo=null;return}
const conditions=getTaskConditions();
const availableTasks=tasks.filter(task=>!task.canSelect||task.canSelect(conditions));
if(availableTasks.length===0){instructions.classList.add('active');instructions.innerHTML="<div>No available tasks for current conditions!</div>";window.lastTaskInfo=null;return}
const randomTask=availableTasks[Math.floor(Math.random()*availableTasks.length)];window.lastTaskInfo={toyId:randomToyObj.toyId,setId:randomToyObj.setId,difficulty:randomToyObj.difficulty,taskType:randomTask.type||'normal'};instructions.classList.add('active');if(randomTask.type==='metronome'){const beatCount=randomTask.getDifficulty(randomToyObj.difficulty,conditions);window.lastTaskInfo.beatCount=beatCount;currentMetronomeTask=createMetronomeTask(beatCount);instructions.innerHTML='';instructions.appendChild(currentMetronomeTask.element)}else if(randomTask.type==='redlight'){const duration=randomTask.getDifficulty(randomToyObj.difficulty,conditions);window.lastTaskInfo.duration=duration;currentMetronomeTask=createRedLightGreenLightTask(duration);instructions.innerHTML='';instructions.appendChild(currentMetronomeTask.element)}else{const content=randomTask.getDifficulty(randomToyObj.difficulty,conditions);instructions.innerHTML=content}}

function displayRandomInstructionWithAddRemove(addRemoveTask){const toys=getSelectedToys();if(currentMetronomeTask){currentMetronomeTask.cleanup();currentMetronomeTask=null}if(toys.length===0){instructions.classList.add('active');instructions.innerHTML="<div>üéØ Select instruction sets and toys to get started!</div>";window.lastTaskInfo=null;return}const randomToyObj=toys[Math.floor(Math.random()*toys.length)],tasks=instructionSets[randomToyObj.setId].tasks[randomToyObj.toyId];if(!tasks||tasks.length===0){instructions.classList.add('active');instructions.innerHTML="<div>No tasks available for this toy!</div>";window.lastTaskInfo=null;return}
const conditions=getTaskConditions();
const availableTasks=tasks.filter(task=>!task.canSelect||task.canSelect(conditions));
if(availableTasks.length===0){instructions.classList.add('active');instructions.innerHTML="<div>No available tasks for current conditions!</div>";window.lastTaskInfo=null;return}
const randomTask=availableTasks[Math.floor(Math.random()*availableTasks.length)];window.lastTaskInfo={toyId:randomToyObj.toyId,setId:randomToyObj.setId,difficulty:randomToyObj.difficulty,taskType:randomTask.type||'normal'};instructions.classList.add('active');

// Prepend add/remove text if present (no special styling)
let addRemoveHTML='';
if(addRemoveTask){const html=addRemoveTask.getHTML();const parser=new DOMParser();const doc=parser.parseFromString(html,'text/html');const strong=doc.querySelector('strong');const paragraphs=doc.querySelectorAll('p');let text='';if(strong)text+=`<strong>${strong.textContent}</strong>`;paragraphs.forEach(p=>text+=`<p>${p.textContent}</p>`);addRemoveHTML=text}

if(randomTask.type==='metronome'){const beatCount=randomTask.getDifficulty(randomToyObj.difficulty,conditions);window.lastTaskInfo.beatCount=beatCount;currentMetronomeTask=createMetronomeTask(beatCount);instructions.innerHTML=addRemoveHTML;instructions.appendChild(currentMetronomeTask.element)}else if(randomTask.type==='redlight'){const duration=randomTask.getDifficulty(randomToyObj.difficulty,conditions);window.lastTaskInfo.duration=duration;currentMetronomeTask=createRedLightGreenLightTask(duration);instructions.innerHTML=addRemoveHTML;instructions.appendChild(currentMetronomeTask.element)}else{const content=randomTask.getDifficulty(randomToyObj.difficulty,conditions);instructions.innerHTML=addRemoveHTML+content}}

function updateToyCheckboxes(){selectedSets=Array.from(document.querySelectorAll('#instructionSetCheckboxes input:checked')).map(cb=>cb.value);const container=document.getElementById('toyCheckboxes');container.innerHTML='';
if(selectedSets.length===0){container.innerHTML='<p style="color: #666; text-align: center; margin: 0;">Select instruction sets first</p>';updateAdvancedSettings();saveGameState();return}
selectedSets.forEach(setId=>{if(instructionSets[setId]){const setHeader=document.createElement('div');setHeader.style.fontWeight='bold';setHeader.style.color='#667eea';setHeader.style.marginTop='10px';setHeader.style.marginBottom='5px';setHeader.textContent=instructionSets[setId].name;container.appendChild(setHeader);instructionSets[setId].toys.forEach(toy=>{const toyKey=`${setId}_${toy.id}`;if(toyQuantities[toyKey]===undefined)toyQuantities[toyKey]=0;if(!toyModifiers[toyKey])toyModifiers[toyKey]={addChance:25,removeChance:15};if(!toyDifficulties[toyKey])toyDifficulties[toyKey]='medium';const itemContainer=document.createElement('div');itemContainer.className='toy-item';const label=document.createElement('label');label.style.cssText='cursor:pointer;color:#333;display:flex;align-items:center;flex:1';const checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.className='toy-checkbox';checkbox.value=toy.id;checkbox.dataset.setId=setId;if(toyQuantities[toyKey]>0)checkbox.checked=true;checkbox.addEventListener('change',()=>{if(checkbox.checked){if(!toyQuantities[toyKey]||toyQuantities[toyKey]===0){toyQuantities[toyKey]=1;document.getElementById(`qty_${toyKey}`).value=1}}else{toyQuantities[toyKey]=0;document.getElementById(`qty_${toyKey}`).value=0}updateAdvancedSettings();saveGameState()});label.appendChild(checkbox);label.appendChild(document.createTextNode(toy.name));const controls=document.createElement('div');controls.style.display='flex';controls.style.alignItems='center';const qtyInput=document.createElement('input');qtyInput.type='number';qtyInput.className='quantity-input';qtyInput.id=`qty_${toyKey}`;qtyInput.min='0';qtyInput.value=toyQuantities[toyKey]||0;qtyInput.onchange=()=>{const qty=Math.max(0,parseInt(qtyInput.value)||0);toyQuantities[toyKey]=qty;qtyInput.value=qty;checkbox.checked=qty>0;updateAdvancedSettings();saveGameState()};controls.appendChild(qtyInput);const difficultySelect=document.createElement('select');difficultySelect.id=`difficulty_${toyKey}`;difficultySelect.style.cssText='padding:4px 8px;border-radius:8px;border:2px solid #667eea;background:white;color:#333;cursor:pointer;font-size:14px';['easy','medium','hard'].forEach(level=>{const opt=document.createElement('option');opt.value=level;opt.textContent=level=='easy'?'Easy üòä':level=='medium'?'Medium üòê':'Hard üò§';if(level==(toyDifficulties[toyKey]||'medium'))opt.selected=true;difficultySelect.appendChild(opt)});const customOpt=document.createElement('option');customOpt.value='custom';customOpt.textContent='Custom ‚öôÔ∏è';customOpt.disabled=true;customOpt.style.display='none';difficultySelect.appendChild(customOpt);difficultySelect.addEventListener('change',()=>{if(difficultySelect.value!=='custom'){toyDifficulties[toyKey]=difficultySelect.value;applyPreset(toyKey,difficultySelect.value)}});controls.appendChild(difficultySelect);itemContainer.appendChild(label);itemContainer.appendChild(controls);container.appendChild(itemContainer)})}});updateAdvancedSettings();saveGameState()}

document.querySelectorAll('#instructionSetCheckboxes input').forEach(cb=>{cb.addEventListener('change',()=>{updateToyCheckboxes();saveGameState()})});

document.getElementById('playerNameInput').addEventListener('input',function(){playerName=this.value;saveGameState()});

function startGame(){const toys=getSelectedToys();if(toys.length===0){alert('‚ö†Ô∏è Please select at least one toy from the instruction sets before starting!');return}playerName=document.getElementById('playerNameInput').value;gameStarted=true;saveGameState();startButton.style.display='none';document.getElementById('instructionSetCheckboxes').parentElement.style.display='none';document.getElementById('toyCheckboxContainer').style.display='none';document.getElementById('advancedSettings').style.display='none';document.querySelector('.prize-settings').style.display='none';instructions.classList.add('active');instructions.innerHTML=`<div style="font-size: 2em; font-weight: bold; color: #667eea; margin-bottom: 20px;">üçÄ Good Luck${playerName?' '+playerName:''}! üçÄ</div><div style="font-size: 1.2em; color: #666; margin-bottom: 20px;">Roll the dice to begin!</div>`;rollDiceButton.style.display='block';diceResult.style.display='block'}

function rollDice(){rollDiceButton.disabled=true;const diceRoll=Math.floor(Math.random()*6)+1;diceResult.textContent=`Dice: ${diceRoll} üé≤`;let nextPosition=playerPosition+diceRoll;if(nextPosition>totalSquares)nextPosition=totalSquares;let finalPosition=nextPosition,showContinueButton=false;const isSnake=snakes[nextPosition],isLadder=ladders[nextPosition];if(isSnake||isLadder){finalPosition=isSnake?snakes[nextPosition]:ladders[nextPosition];showContinueButton=true}
    
const addRemoveTask=rollForAddRemoveTasks();

animatePlayer(playerPosition,nextPosition,()=>{playerPosition=nextPosition;

// Execute add/remove task and update state before showing instruction
if(addRemoveTask){addRemoveTask.execute()}

// Now display the regular task (with add/remove text prepended if applicable)
displayRandomInstructionWithAddRemove(addRemoveTask);
saveGameState();

if(playerPosition===totalSquares){rollDiceButton.disabled=true;const prize=determinePrize();instructions.innerHTML=`<div><strong>üéâ Congratulations, you've won! üéâ</strong></div>`+displayPrizeResult(prize);return}

instructions.appendChild(continueButton);continueButton.style.display="block";

if(showContinueButton){continueButton.onclick=()=>{if(currentMetronomeTask&&!currentMetronomeTask.isComplete())return;continueButton.style.display="none";animatePlayer(nextPosition,finalPosition,()=>{playerPosition=finalPosition;if(playerPosition===totalSquares){rollDiceButton.disabled=true;const prize=determinePrize();instructions.innerHTML=`<div><strong>üéâ Congratulations, you've won! üéâ</strong></div>`+displayPrizeResult(prize);saveGameState()}else{rollDiceButton.disabled=false;instructions.innerHTML=`<div><strong>üìç You landed on ${finalPosition}.</strong></div>`;displayRandomInstruction();saveGameState()}},true)}}else{continueButton.onclick=()=>{if(currentMetronomeTask&&!currentMetronomeTask.isComplete())return;continueButton.style.display="none";rollDiceButton.disabled=false}}});}

const modal=document.getElementById('patchNotesModal'),btn=document.getElementById('patchNotesBtn'),span=document.getElementsByClassName('close-btn')[0];btn.onclick=()=>modal.style.display='block';span.onclick=()=>modal.style.display='none';window.onclick=e=>{if(e.target==modal)modal.style.display='none'};

const resetBtn=document.getElementById('resetBtn'),resetModal=document.getElementById('resetModal'),confirmResetBtn=document.getElementById('confirmReset'),cancelResetBtn=document.getElementById('cancelReset');resetBtn.addEventListener('click',()=>resetModal.style.display='block');cancelResetBtn.addEventListener('click',()=>resetModal.style.display='none');confirmResetBtn.addEventListener('click',function(){resetModal.style.display='none';localStorage.removeItem('snakesLaddersGameState');gameStarted=false;playerPosition=0;playerName='';player.remove();bodyPartState=JSON.parse(JSON.stringify(bodyParts));startButton.style.display='block';rollDiceButton.style.display='none';rollDiceButton.disabled=false;continueButton.style.display='none';instructions.classList.remove('active');instructions.innerHTML='';diceResult.textContent='Dice: -';diceResult.style.display='none';document.getElementById('playerNameInput').value='';document.getElementById('instructionSetCheckboxes').parentElement.style.display='block';document.getElementById('toyCheckboxContainer').style.display='block';document.getElementById('advancedSettings').style.display='block';document.querySelector('.prize-settings').style.display='block';document.querySelectorAll('#instructionSetCheckboxes input').forEach(cb=>cb.checked=false);selectedSets=[];toySelections={};toyDifficulties={};toyQuantities={};toyModifiers={};advancedSettingsOpen=false;prizeSettings={minor:25,major:10,noPrize:65};updateSliderDisplays();document.getElementById('toyCheckboxes').innerHTML='<p style="color: #666; text-align: center; margin: 0;">Select instruction sets first</p>';updateAdvancedSettings()});

startButton.addEventListener('click',startGame);rollDiceButton.addEventListener('click',rollDice);createBoard();loadGameState();
    </script>
</body>
</html>
